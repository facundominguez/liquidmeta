\documentclass[11pt]{article}
\usepackage{amssymb,amsmath,amsthm}
\usepackage[margin=1.25in]{geometry}
\usepackage{graphicx,ctable,booktabs}
\usepackage{textcomp,stmaryrd}
\usepackage{mathpartir}
\allowdisplaybreaks

\newtheorem{theorem}{Theorem}%[section]
\newtheorem{lemma}[theorem]{Lemma}
\newtheorem{proposition}[theorem]{Proposition}
\newtheorem{corollary}[theorem]{Corollary}

%%%%% Set up the header
\usepackage{fancyhdr}
\usepackage{extramarks} % fixes the buggy section numbering
\usepackage{comment}
\pagestyle{fancy}
\lhead{Liquid Meta}
\chead{}
\rhead{\thepage}
\renewcommand{\headrulewidth}{.3pt}
\setlength\voffset{-0.25in}
\setlength\textheight{648pt}

\newcommand{\al}{\alpha}
\newcommand{\eps}{\varepsilon}
\newcommand{\bind}{\hspace{0.05em}{:}\hspace{0.05em}} %x:t w/o space
\newcommand{\col}{\mathbin{:}}       % e : t with a little space
\newcommand{\lb}{\llbracket}         % [[
\newcommand{\rb}{\rrbracket}         % ]]
\newcommand{\step}{\hookrightarrow}
\newcommand{\many}{\hookrightarrow^*}

\newcommand{\true}{\mathtt{true}}
\newcommand{\Int}{{\sf Int}}
\newcommand{\Bool}{{\sf Bool}}

\newcommand{\existype}[3]{\exists\, #1\bind #2.\, #3}
\newcommand{\polytype}[3]{\forall\, #1\bind #2.\, #3}
\newcommand{\functype}[3]{#1\bind #2 \rightarrow #3}
\newcommand{\foralltheta}{\forall\theta.\,\theta\in\lb\Gamma\rb}
\newcommand{\letin}[3]{{\tt let}\,#1\hspace{0.1em}{=}\hspace{0.1em}#2\,{\tt in}\,#3}
\newcommand{\dom}[1]{{\rm dom}(#1)}

%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}

\title{Liquid Meta}
\author{\textsc{Michael Borkowski} \\ (summarizing joint work with {\sc Ranjit Jhala} and {\sc Niki Vazou})}
\date{June 30, 2020}

\maketitle
\thispagestyle{empty}

\section{Our language $\lambda_2$}

We work with a polymorphic, typed lambda calculus with call-by-value semantics which is augmented by refinement types, dependent function types, and existential types. Our language is based on the Sprite language $\lambda$ in Jhala and Vazou's forthcoming manuscript [JV] and incorporates and extends aspects from the $\lambda^H$ of Vazou et al [VSJ$^+$14]. The existential types were used in a metatheory by Knowles and Flanagan [KF09].

We start with the syntax of term-level expressions in our language:

\begin{align*}
{\sf Values} \;\;\; v :&=\;\: {\tt true}, {\tt false}
                         {\kern 5em}& boolean\; constants\\
                   &\;\;|\quad 0, 1, 2, \ldots 
                         & integer \; constants\\
                   &\;\;|\quad x & variables\\
                   &\;\;|\quad \lambda x . e
                         & abstractions \\
                   &\;\;|\quad \Lambda \alpha\bind k .e
                         & type\; abstractions\\
                   &\;\;|\quad \wedge, \; \vee, \;\neg,\; 
                         \leftrightarrow,\; \leq,\; =                     
                         & built{\rm -}in\; primitives 
\end{align*}
\begin{align*}
{\sf Expressions} \;\;\; e :&=\;\: v {\kern 5 em}& values \\
	                &\;\;|\quad e_1\; e_2 & applications \\
	                &\;\;|\quad e\; [t] & type\; applications\\
	                &\;\;|\quad {\tt let}\; x = e_1
	                      \; {\tt in} \; e_2 & let\; expressions\\
	                &\;\;|\quad e_1 \col t & annotations \\
\end{align*}

Next, we give the syntax of the types and binding environments used in our language:

\begin{align*}
{\sf Basic\; types} \quad b :&=\;\;{\sf Bool}{\kern 5em}&booleans\\
                   &\;\;|\quad {\sf Int} &integers \\ \\
{\sf Types} \quad t :&=\;\; b\{r\} & refinement \\
                   &\;\;|\quad \al &type\; variables \\
                   &\;\;|\quad x\bind t_x \rightarrow t 
                   &dependent\; function\\
                   &\;\;|\quad \exists\, x\bind t_x.\, t 
                   &existential\\ 
                   &\;\;|\quad \forall\, \al\bind k.\, t
                   &polymorphic\\ \\
{\sf Kinds} \quad k :&= \;\; B &base\; kind \\
                   &\;\;|\quad\, * &star\; kind \\ \\
%\end{align*}
%\begin{align*}
{\sf Environments} \quad \Gamma :&=\;\; \varnothing
                   {\kern 5em}& empty \\
                   &\;\;|\quad \Gamma, x\bind t & bind\;variable\\
                   &\;\;|\quad \Gamma, \al\bind k & bind\;type\;variable\\
\end{align*}

Note that a basic type $b$ is not a proper type; to express $b$ as a type we must write $b\{x\col\true\}$. Next, we give the syntax of the Boolean predicates and constraints involved in refinements and subtyping judgments. The ternary judgment $\vdash_B \; :$ is the typing judgment in the underlying System F calculus.

\begin{align*}
{\sf Refinements} \;\; r :&= \{x\col p\}  \\ \\
{\sf Predicates} \;\; p :&=\;\: \{ e \;|\; \exists\, \Gamma.\, 
                   \Gamma \vdash_B e : {\sf Bool}\}
                   {\kern 3 em}& expressions\; of\; type\; {\sf Bool} 
\end{align*}
In the metatheory here we require that all variables bound in the environment be distinct. In the mechanization we use the locally-named representation: free and bound variables become distinct objects in the syntax. All free variables have unique names and these names never conflict with bound variables, which eliminates the possibility of capture in substitution and the need to perform alpha-renamings during substitution. This came at the cost of needing formal lemmas which permit us to change the name of a variable bound in the environment to maintain the uniqueness of the free variables only.

Our definition of predicates above departs from the Sprite languages of [JV] by allowing predicates to be arbitrary expressions from the main language (which are Boolean typed under the appropriate binding environment).
In [JV] however, predicates are quantifier-free first-order formulae over a vocabulary of integers and a limited number of relations. We initially took this approach, but were unable to fully define the denotational semantics for this type of language. In particular, when we define closing substitutions we need to define the substitution of a type $\theta(t)$ as the type resulting from $t$ after performing substitutions for all variables bound to values in
$\theta = (x_1 \mapsto v_1, \ldots, x_n \mapsto v_n)$. Substituting arbitrary expressions into $t$ requires substituting arbitrary expressions into predicates, and it isn't clear how to do this for functions like $(\lambda x. x)$ without taking predicates to be all Boolean-typed program expressions. \\

Returning to our $\lambda_2$, we next define the operational semantics of the language. We treat the reduction rules (small step semantics) of the various built-in primitives as external to our language, and we denote by $\delta(c,v)$ a function specifying them. The reductions are defined in a curried manner, so for instance we have that 
$c\; v_1\; v_2 \many \delta(\delta(c,v_1),v_2)$. Currying gives us unary relations like $m\!\!\leq$ which is a partially evaluated version of the $\leq$ relation.
\begin{align*}
\delta(\wedge,\true) &:= \lambda x.\, x &
  \delta(\leftrightarrow,\true) &:= \lambda x.\, x\\
\delta(\wedge,{\tt false}) &:= \lambda x.\, {\tt false} &
  \delta(\leftrightarrow,{\tt false}) &:= \lambda x.\, \neg x\\
\delta(\vee,\true) &:= \lambda x.\, \true &
  \delta(\leq,m) &:= m\!\!\leq  \\
\delta(\vee,{\tt false}) &:= \lambda x.\, x &
  \delta(m\!\!\leq, n) &:= {\tt bval}(m \leq n)\\ 
\delta(\neg,\true) &:= {\tt false} & 
  \delta(=,m) &:= m\!\!= \\
\delta(\neg,{\tt false}) &:= \true &
  \delta(m\!\!=, n) &:= {\tt bval}(m = n)
\end{align*}

Now we give the reduction rules for the small-step semantics. In what follows, $e$ and its variants refer to an arbitrary expression, $v$ refers to a value, $x$ to a variable, and $c$  refers to a built-in primitive.  
\begin{mathpar} %%%%%%%%% SMALL-STEP SEMANTICS %%%%%%%%%%
\inferrule*[Right=E-Prim]{  }{c\; v \step \delta(c,v)} \and
\inferrule*[Right=E-App1]{e \step e'}{e\; e_1 \step e'\; e_1} \\
\inferrule*[Right=E-App2]{e \step e'}{v\; e \step v \; e'} \and
\inferrule*[Right=E-AppAbs]{ }
  {(\lambda x.\, e)\; v \step e[v/x]} \\
\inferrule*[Right=E-AppT]{e \step e'}{e\; [t] \step e'\; [t]} \and
\inferrule*[Right=E-AppTAbs]{ }
  {(\Lambda \al\bind k.\, e)\; [t] \step e[t/\al]} \\ 
\inferrule*[Right=E-Let]{ e_x \step e'_x}
  {\letin{x}{e_x}{e} \step \letin{x}{e'_x}{e}} \and
\inferrule*[Right=E-LetV]{ }{\letin{x}{v}{e} \step e[v/x]} \\
\inferrule*[Right=E-Ann]{e \step e'}{e \col t \step e' \col t}\and
\inferrule*[Right=E-AnnV]{ }{v \col t \step v}
\end{mathpar}

We give the details of the type substitution operation used above in {\sc E-AppTAbs}: {\em (note: decide on whether the type variable is a basic type or whether it  cannot be refined)}
\begin{align*}
b\{x\col p\}[t_\al/\al] :&= b\{x\col p[t_\al/\al]\} \\
\al[t_\al/\al] :&= t_\al \\
(\functype{x}{t_x}{t})[t_\al/\al] :&= \functype{x}{(t_x[t_\al/\al])}{t[t_\al/\al]} \\
(\existype{x}{t_x}{t})[t_\al/\al] :&= \existype{x}{(t_x[t_\al/\al])}{t[t_\al/\al]} \\
(\polytype{\al'}{k}{t})[t_\al/\al] :&= \polytype{\al'}{k}{t[t_\al/\al]} \quad\quad\quad\quad\quad\quad\quad\quad \al \neq \al'
\end{align*}

Next, we define the typing rules of our $\lambda_2$.
The type judgments in the language $\lambda_2$ will be denoted $\vdash$ with a colon between term and type. For clarity, we distinguish between this and other judgments by using $\vdash$ with a subscript in most other settings. For instance, the judgement $\Gamma \vdash_w t : k$ says that type $t$ is well-formed in environment $\Gamma$ and has kind $k$:
\begin{mathpar}      %%%%%%%%%%%% WELL-FORMEDNESS %%%%%%%%%%%%%
\inferrule*[Right=WF-Refn]{y\bind b, \lfloor\Gamma\rfloor \vdash_B e[y/x] : \Bool \quad\;\; y \not\in {\rm dom}(\Gamma)}
{\Gamma \vdash_w b\{x\col e\} : B} \and
\inferrule*[Right=WF-Kind]{\Gamma \vdash_w t : B}{\Gamma\vdash_w t : *} \\
\inferrule*[Right=WF-Var]{\al :k \in \Gamma}{\Gamma \vdash_w \al : k}\and
\inferrule*[Right=WF-Func]
{\Gamma \vdash_w t_x : k_x \quad\; y\bind t_x, \Gamma  \vdash_w t[y/x] : k \quad\; y \not\in {\rm dom}(\Gamma)}
{\Gamma \vdash_w x\bind t_x \rightarrow t : *} \\
\inferrule*[Right=WF-Exis]
{\Gamma \vdash_w t_x : k_x \quad y\bind t_x, \Gamma \vdash_w t[y/x] : k \quad y \not\in{\rm dom}(\Gamma)}
{\Gamma \vdash_w \exists\, x\bind t_x .\, t : k} \\
\inferrule*[Right=WF-Poly]
{\al'\bind k, \Gamma \vdash_w t[\al'/\al] : k_t \quad \al' \not\in 
{\rm dom}(\Gamma)}
{\Gamma \vdash_w \forall\,\al\bind k.t : * }
\end{mathpar}

The judgment $\vdash_w \Gamma$ says that the environment $\Gamma$ is well formed, meaning that variables are only bound to well-formed types. We adopt the convention that our environments grow from right to left.
\begin{mathpar}
\inferrule*[Right=WFE-Empty]{ }{\vdash_w \varnothing} \and
\inferrule*[Right=WFE-Bind]{\Gamma \vdash_w t_x : k_x  \quad \vdash_w \Gamma \quad x\not\in{\rm dom}(\Gamma)}{\vdash_w x\bind t_x, \Gamma}\\
\inferrule*[Right=WFE-BindT]{\vdash_w \Gamma \quad \al\not\in{\rm dom}(\Gamma)}{\vdash_w \al\bind k, \Gamma}
\end{mathpar}

Now we give the rules for the typing judgements. As with the reduction rules, we take the type of our built-in primitives to be external to our language. We denote by $ty(c)$ the function that specifies the most specific type possible for $c$. More details on $ty(c)$ are given in the next section.
In order to express the exact type of variables, we introduce a ``selfification'' function that strengthens a refinement we the condition that a value is equal to itself; this is key to derive the fine grained type of $\lambda x.x$ being $x\bind\Bool\{z\col \true\} \rightarrow \Bool\{z \col z = x\}$. Our metatheory only requires that we can selfify base types and existential quantifications of them; this will simplify the development below. 
{\em The $=$ in the $z=x$ definition below is overloaded, but in our mechanization we would use either $z\leftrightarrow x$ or $z=x$ depending on the base type. But if we can refine type variables, then  $=$ should be polymorphic.}
\begin{align*}
{\rm self}(b\{z\col p\}, x):&= b\{z\col p \wedge z = x\} \\
{\rm self}(\al, x) :&= \al \\
{\rm self}(\functype{z}{t_z}{t}, x) :&= \functype{z}{t_z}{t} \\
{\rm self}(\existype{z}{t_z}{t}, x) :&= \existype{z}{t_z}{{\rm self}(t, x)} \\
{\rm self}(\polytype{\al}{k}{t}, x) :&= \polytype{\al}{k}{t} 
\end{align*}

\begin{mathpar}             %%%%%%%%%%%%% TYPING %%%%%%%%%%%%%%%%%%
\inferrule*[Right=T-Prim]{ty(c) = t}{\Gamma \vdash c : t} \and
\inferrule*[Right=T-Var]{x\bind t \in \Gamma}{\Gamma \vdash x:{\rm self}(t,x)}\and
\inferrule*[Right=T-App]
{\Gamma \vdash e \,:\, x\bind t_x \rightarrow t \qquad \Gamma \vdash e' : t_x}
{\Gamma \vdash e\; e' : \exists\, x\bind t_x.\, t} \\
\inferrule*[Right=T-Abs]
{y\bind t_x, \Gamma \vdash e[y/x]:t[y/x] \quad\; \Gamma\vdash_w t_x : k_x \quad\; y \not\in {\rm dom}(\Gamma)}
{\Gamma \vdash \lambda x.\, e \,:\, x\bind t_x \rightarrow t}\\
\inferrule*[Right=T-AppT]
{\Gamma \vdash e \,:\, \polytype{\al}{k}{s} \qquad \Gamma \vdash_w t : k}
{\Gamma \vdash e [t] : s[t/\al]} \\
\inferrule*[Right=T-AbsT]
{\al'\bind k, \Gamma \vdash e [\al'/\al] : t [\al'/\al] \quad\; 
 \al'\bind k, \Gamma \vdash_w t [\al'/\al] : k' \quad\; \al'\not\in {\rm dom}(\Gamma)}
{\Gamma \vdash \Lambda \al\bind k. e : \polytype{\al}{k}{t}} \\
\inferrule*[Right=T-Let]
{\Gamma \vdash e_x : t_x \quad\; y\bind t_x, \Gamma \vdash e[y/x] : t[y/x] \quad\; \Gamma \vdash_w t : k \quad\; y \not\in {\rm dom}(\Gamma)}
{\Gamma \vdash \letin{x}{e_x}{e} : t} \\
\inferrule*[Right=T-Ann]{\Gamma\vdash e:t \quad\; \Gamma \vdash_w t : k}{\Gamma\vdash e\col t\,:\,t}
\and \inferrule*[Right=T-Sub]
{\Gamma\vdash e:s \qquad \Gamma\vdash s<:t \qquad\Gamma\vdash_w t:k}
{\Gamma \vdash e : t}
\end{mathpar}

The last rule, {\sc T-Sub}, uses the subtyping judgement $\Gamma \vdash s <: t$. The subtyping rules are as follows:

\begin{mathpar}   %%%%%%%%%%%%%%%%%% SUBTYPING %%%%%%%%%%%%%%%%%%
\inferrule*[Right=S-Base]
{y\bind b\{x_1\col p_1\}, \Gamma \vdash_e p_2[y/x_2] \qquad y\not\in {\rm dom}(\Gamma)}
{\Gamma \vdash b\{x_1\col p_1\} <: b\{x_2\col p_2\}} \and 
\inferrule*[Right=S-Func]
{\Gamma \vdash s_2 <: s_1 \qquad y\bind s_2, \Gamma \vdash t_1[y/x_1] <: t_2[y/x_2] \qquad y \not\in {\rm dom}(\Gamma)}
{\Gamma \vdash x_1\bind s_1 \rightarrow t_1 <: x_2\bind s_2\rightarrow t_2} \\
\inferrule*[Right=S-Witn]
{\Gamma \vdash v_x : t_x \qquad \Gamma \vdash t <: t'[v_x/x]}
{\Gamma \vdash t <: \exists\, x\bind t_x.\, t'} \and
\inferrule*[Right=S-Bind] 
{y\bind t_x, \Gamma \vdash t[y/x] <: t' \quad y \not\in free(t')}
{\Gamma \vdash \exists\, x\bind t_x.\, t <: t'} \\
\inferrule*[Right=S-Poly]
{\al\bind k, \Gamma \vdash t_1[\al/\al_1] <: t_2[\al/\al_2] \qquad \al \not\in {\rm dom}(\Gamma) }
{\Gamma \vdash \polytype{\al_1}{k}{t_1} <: \polytype{\al_2}{k}{t_2}}\\
\end{mathpar}

The first rule above, {\sc S-Base}, uses the entailment judgement $\Gamma \vdash_e p$ which (roughly) states that predicate $p$ is valid (in the sense of a logical formula) when universally quantified over all variables bound in environment $\Gamma$.
We give the inference rule for the entailment judgement:

\begin{mathpar}
\inferrule*[Right=Ent-Pred]
{\forall\, \theta.\, \theta\in \lb\Gamma\rb \Rightarrow \theta(p) \many \true}
{\Gamma \vdash_e p}
\end{mathpar}

Note that if we combine rules {\sc T-AbsT} and {\sc S-Poly} then we can derive the following judgment, which shows that polymorphic types are equivalent up to alpha-renaming bound type variables:

\begin{mathpar}
\inferrule*[Right=T-AbsT']
{\al\bind k, \Gamma \vdash e [\al/\al_1] : t [\al/\al_2] \quad\; 
 \al\bind k, \Gamma \vdash_w t : k' \quad\; \al\not\in {\rm dom}(\Gamma)}
{\Gamma \vdash \Lambda \al_1\bind k. e : \polytype{\al_2}{k}{t}}
\end{mathpar}

\section{Preliminaries}   %%%%%%%%%%% 2222222222222 %%%%%%%%

For clarity, we distinguish between different typing judgments with a subscript.  The type judgments in the underlying polymorphic lambda calculus (System F) will be denoted by $\vdash_B$ and a colon before the type. In order to speak about the base type underlying some type, we define a function that erases refinements in types:
\[
\lfloor b\{x:p\} \rfloor := b, \quad \lfloor \al \rfloor := \al, \quad
\lfloor x\bind t_x \rightarrow t\rfloor := \lfloor t_x \rfloor \rightarrow \lfloor t \rfloor, \quad
\lfloor \exists\, x\bind t_x.\, t\rfloor := \lfloor t\rfloor,
\quad{\rm and}\quad
\lfloor \polytype{\al}{k}{t} \rfloor := \polytype{\al}{k}{\lfloor t\rfloor}
\]
We start our development of the meta-theory by giving a definition of {\em type denotations}. Roughly speaking, the denotation of a type $t$ without type variables is the class of value terms $v$ with the correct underlying base type such that this term satisfies the refinement predicates that appear within the structure of $t$. We formalize this notion with a recursive definition:
\begin{align*}
\lb b \rb \,&:= \{ v \;|\; \varnothing \vdash_B v : b\}\\
\lb b\{x\col p\}\rb \,&:= 
  \{ v \;|\; (\varnothing \vdash_B v:b)
\,\wedge\, (%{\rm if}\, e \many v \,{\rm then}\, 
p[v/x] \many {\tt true})\} \\
\lb x\bind t_x \rightarrow t\rb \,&:= 
\{ v\,|\; (\varnothing \vdash_B v : \lfloor t_x\rfloor \rightarrow \lfloor t\rfloor ) \,\wedge\,
( \forall\, v_x \in \lb t_x \rb.\, v\; v_x \many v' \,{\rm such\, that}\, v' \in \lb t[v_x/x] \rb)\} 
\\
\lb \exists\, x\bind t_x .\, t\rb \,&:= 
\{ v \,|\; (\varnothing \vdash_B v : \lfloor t\rfloor ) \,\wedge\,
( \exists\, v_x \in \lb t_x \rb.\, v\in \lb t[v_x/x] \rb)\}
\\
\lb\polytype{\al}{k}{t}\rb \,&:= \{ v \,|\; 
( \varnothing \vdash_B v : \polytype{\al}{k}{\lfloor t \rfloor}) \,\wedge\,
( \forall\, t_\al.\, (\varnothing \vdash_w t_\al : k) \Rightarrow 
v\, [t_\al] \many v' \,{\rm such\, that}\, v' \in \lb t [t_\al/\al] \rb)
\}
\end{align*}
The denotation of a type variable $\al$ is undefined.

We also have the concept of the denotation of an environment $\Gamma$; we intuitively define this to be the set of all sequences of value bindings for the term variables and type bindings for the type variables in $\Gamma$ such that the values respect the denotations of the types of the corresponding variables.
A closing substitution is just a sequence of value bindings to variables:
\[
\theta = (x_1\mapsto v_1,\,\ldots,\, x_n\mapsto v_n, \al_1 \mapsto t_1, \,\ldots,\, \al_m\mapsto t_m)
\quad {\rm with\, all}\, x_i, \al_j\, {\rm distinct}
\]
% Note that here in the metatheory 
We use the shorthand $\theta(x)$ to refer to $v_i$ if $x = x_i$ and we use $\theta(\al)$ to refer to $t_j$ if $\al = \al_j$. We define $\theta(t)$ to be the type derived from $t$ by substituting for all variables in $\theta$:
\[
\theta(t) := t[v_1/x_1]\cdots[v_n/x_n][t_1/\al_1]\cdots[t_m/\al_m]
\]
Then we can formally define the denotation of an environment:
\begin{align*}
\lb \Gamma \rb := \{ \theta =& (x_1 \mapsto v_1,\ldots, x_n \mapsto v_n,  \al_1 \mapsto t_1, \,\ldots,\, \al_m\mapsto t_m) \\ \; | \;&
\forall\, (x:t) \in \Gamma.\, \theta(x) \in \lb\theta(t)\rb \;\wedge\;
\forall\, (\al:k) \in \Gamma.\, \varnothing \vdash_w \theta(\al) : k \}.
\end{align*}

For each built-in primitive constant or function $c$ we define $ty(c)$ to include the most specific possible refinement type for $c$.
\begin{align*}
ty(\true) :=&\; \Bool\{ x : x = \true \}\\
ty({\tt false}) :=&\; \Bool\{ x : x = {\tt false}\}\\
ty(3) :=&\; \Int\{ x : x = 3\} \\
ty(n) :=&\; \Int\{ x : x = n\} \\
ty(\wedge) :=&\; 	x\bind\Bool \rightarrow y\bind\Bool \rightarrow \Bool\{ v : v = x \wedge y\}\\
ty(\neg) :=&\; x\bind\Bool \rightarrow \Bool\{ y : y = \neg x\}\\
ty(\leq) :=&\; x\bind\Int \rightarrow y\bind\Int \rightarrow \Bool\{v : v = (x \leq y)\}\\
ty(m\!\!\leq) :=&\; n\bind\Int \rightarrow \Bool\{v : v = (m \leq n)\}\\
ty(=) :=&\; x\bind\al \rightarrow y\bind\al \rightarrow \Bool\{ v : v = (x = y) \} 
\end{align*}
and similarly for the others % $ty(\vee)$, $ty(=)$, and $ty(m\!\!=)$. 
Note that we use $m\!\!\leq$ to represent an arbitrary member of the infinite family of primitives $0\!\!\leq,\, 1\!\!\leq,\, 2\!\!\leq,\ldots$. Then by the definitions above we get our primitive typing lemma:

\begin{lemma}(Primitive Typing) For every primitive $c$, 
\begin{enumerate}
\item $\varnothing \vdash c : ty(c)$. % and $\varnothing \vdash_w ty(c)$.  
\item If $ty(c) = b\{x \col p\}$, then $\varnothing \vdash_w ty(c) : B$,\, $c \in \lb ty(c) \rb$ and for all $c'$ such that $c' \neq c$, $c' \not\in \lb ty(c)\rb$.
\item If $ty(c) = \functype{x}{t_x}{t}$, then $\varnothing \vdash_w ty(c) : * $ and for each $v \in \lb t_x\rb$, $\delta(c,v)$ is defined and we have both $\varnothing \vdash \delta(c,v) : t[v/x] $ and $\delta(c,v) \in \lb t[v/x] \rb$. Thus $c \in \lb ty(c) \rb$.
\end{enumerate}\label{prim-typing}
\end{lemma}

\section{Meta-theory}  %%%%%%%%%%%%%%% 333333333333 %%%%%%%%%%%%%

In this section, we seek to prove the operational soundness of our language $\lambda_1$. We begin by stating several standard properties and proving some basic facts used later on.

\begin{lemma}\label{value-sub}
Values are closed under substitution of variables for values. If $v$ is a value and $x \in {\rm free}(v)$ then for any value $v_x$, we have that $v[v_x/x]$ is also a value.
\end{lemma}

\begin{lemma}\label{step-determ}
The operational semantics of $\lambda_2$ are deterministic: For every expression $e$ there exists at most one term $e'$ such that $e \step e'$. (Moreover there exists at most one value term $v$ such that $e \many v$.) Furthermore, a value $v$ cannot be evaluated any further.
\end{lemma}

\begin{lemma}\label{weakenings}
(Weakenings of Judgments) For any environments $\Gamma$, $\Gamma'$ and $x,\al \not\in dom(\Gamma', \Gamma)$:
\begin{enumerate}
\item If $\Gamma', \Gamma \vdash e : t$ then $\Gamma', x\bind t_x, \Gamma \vdash e :  t$ and $\Gamma', \al\bind k, \Gamma \vdash e :  t$.
\item If $\Gamma', \Gamma \vdash s <: t$ then $\Gamma', x\bind t_x, \Gamma \vdash s <: t$ and $\Gamma', \al\bind k, \Gamma \vdash s <: t$.
\item If $\Gamma', \Gamma \vdash_e p$ then $\Gamma', x\bind t_x, \Gamma \vdash_e p$ and $\Gamma', \al\bind k, \Gamma \vdash_e p$.
\item If $\Gamma', \Gamma \vdash_w t:k$ then $\Gamma', x\bind t_x, \Gamma \vdash_w t:k$ and $\Gamma', \al\bind k, \Gamma \vdash_w t:k$.
\end{enumerate}
\end{lemma}
\begin{proof}
The proof is by straightforward mutual induction on the derivation trees of each type of judgment. In the base cases we rely on weakening typing judgments in the underlying System F ({\sc WF-Base}) and on the fact that we can add extra variables to a closing substitution that don't appear in a predicate ({\sc Ent-Pred}).
\end{proof}

\begin{lemma}\label{sub-refl}
(Reflexivity of $<:$) If $\Gamma \vdash_w t : k$ and $t$ is not a type variable then $\Gamma \vdash t <: t$.
\end{lemma}

\begin{proof} We proceed by induction of the structure of the derivation of $\Gamma \vdash_w t : k$. {\em We could dispense with the hypothesis that $t \not\equiv \al$ by either making $\al$ a basic type or adding another subtyping rule that states $(\al\col k)\in\Gamma \Rightarrow \Gamma \vdash \al <: \al$}

{\bf Case} {\sc WF-Refn}: In the base case, we have $t \equiv b{x\col p}$ and $k \equiv B$. By inversion, we have for some $y \not\in \dom{\Gamma}$, the judgment $y\bind b, \lfloor \Gamma \rfloor \vdash_B p[y/x] : \Bool$. Let $\theta \in \lb y\bind b\{x\col p\}, \Gamma\rb$. Then we have that $\theta(y) \in \lb\theta(b\{x\col p\})\rb = \lb b\{x\col \theta(p)\}\rb$, and so $\theta(p)[\theta(y)/x] \many \true$. But $\theta(p)[\theta(y)/x] = \theta(p[y/x])$, and so by rule {\sc Ent-Pred}, $y\bind b\{x\col p\}, \Gamma \vdash_e p[y/x]$. By {\sc S-Base}, we conclude $\Gamma \vdash b\{x\col p\} <: b\{x \col p\}$.
	
{\bf Case} {\sc WF-Kind}:  We have $\Gamma \vdash_w t : *$ and by inversion we have $\Gamma \vdash_w t : B$. By induction, we get $\Gamma \vdash t <: t$ as desired.

{\bf Case} {\sc WF-Func}:  We have $t \equiv \functype{x}{t_x}{t'}$ and $k \equiv *$. By inversion, for some $y \not\in\dom{\Gamma}$ and some $k_x, k$ we have
\[
\Gamma\vdash_w t_x : k_x \;\;{\rm and}\;\; y\bind t_x,\Gamma \vdash_w t'[y/x] : k.
\]
By the inductive hypothesis, we have $\Gamma \vdash t_x <: t_x$ and also $y\bind t_x, \Gamma \vdash_w t'[y/x] <: t'[y/x]$. Then by rule {\sc S-Func} we have $\Gamma \vdash \functype{x}{t_x}{t'} <: \functype{x}{t_x}{t'}$.

{\bf Case} {\sc WF-Exis}:  We have $t \equiv \existype{x}{t_x}{t'}$, and by inversion, for some $y \not\in\dom{\Gamma}$ and some $k_x$ we have
\[
\Gamma\vdash_w t_x : k_x \;\;{\rm and}\;\; y\bind t_x,\Gamma \vdash_w t'[y/x] : k.
\]
By rule {\sc T-Var} and the fact that $y\bind t_x, \Gamma \vdash {\rm self}(t_x, y) <: t_x$ we have $y\bind t_x, \Gamma \vdash y : t_x$. By the inductive hypothesis we have $y\bind t_x, \Gamma \vdash t'[y/x] <: t'[y/x]$. 
Then by rule {\sc S-Witn} (where $v_x \equiv y$) we have $y\bind t_x, \Gamma \vdash t'[y/x] <: \existype{x}{t_x}{t'}$. Then applying rule {\sc S-Bind} we have $\Gamma \vdash \existype{x}{t_x}{t'} <: \existype{x}{t_x}{t'}$ as desired.

{\bf Case} {\sc WF-Poly}: We have $t \equiv \Lambda\al\bind k.t'$ and $\Gamma \vdash_w\Lambda\al\bind k.t' : *$. By inversion we have for some $\al' \not \in {\rm dom}(\Gamma)$, 
$\al'\bind k, \Gamma\vdash_w t'[\al'/\al]: k_t$. By induction, we have
$\al'\bind k, \Gamma\vdash t'[\al'/\al] <: t'[\al'/\al]$. By rule {\sc S-Poly} we conclude that $\Gamma \vdash \polytype{\al}{k}{t'} <: \polytype{\al}{k}{t'}$.
\end{proof}

\begin{lemma}\label{sub-erase} If $\Gamma \vdash t_1 <: t_2$ then $\lfloor t_1 \rfloor \overset{\al}{=} \lfloor t_2 \rfloor$. 
\end{lemma}
\begin{proof}
We proceed by structural induction on the derivation tree of $\Gamma \vdash t_1 <: t_2$. In the base case {\sc Sub-Base}, $t_1 \equiv b\{x_1\col p_1\}$ and $t_2 \equiv b\{x_2\col p_2\}$. Then $\lfloor t_1 \rfloor = b = \lfloor t_2 \rfloor$

{\bf Case} {\sc Sub-Func}: We have $t_1 \equiv \functype{x_1}{s_1}{t'_1}$ and $t_2 \equiv \functype{x_2}{s_2}{t'_2}$. By inversion we have for some $y\not\in\dom{\Gamma}$ that $\Gamma \vdash s_2 <: s_1$ and $y\bind s_2,\Gamma \vdash t'_1[y/x_1] <: t'_2[y/x_2]$. By the inductive hypothesis, $\lfloor s_2 \rfloor \overset{\al}{=} \lfloor s_1 \rfloor$ and $\lfloor t'_1 \rfloor = \lfloor t'_1[y/x_1] \rfloor \overset{\al}{=} \lfloor t'_2[y/x_2] \rfloor = \lfloor t'_2 \rfloor.$ Combining these we obtain 
$\lfloor t_1 \rfloor = \lfloor s_1 \rfloor \rightarrow \lfloor t'_1 \rfloor \overset{\al}{=} \lfloor s_2 \rfloor \rightarrow \lfloor t'_2 \rfloor = \lfloor t_2 \rfloor$ as desired.

{\bf Case} {\sc Sub-Witn}: We have $\Gamma \vdash t_1 <: t_2$ where $t_2 \equiv \existype{x}{t_x}{t'}$. By inversion $\Gamma \vdash t_1 <: t'[v_x/x]$ and by the inductive hypothesis $\lfloor t_1 \rfloor \overset{\al}{=} \lfloor t'[v_x/x] \rfloor = \lfloor t' \rfloor = \lfloor \existype{x}{t_x}{t'} \rfloor$.

{\bf Case} {\sc Sub-Bind}: We have $\Gamma \vdash t_1 <: t_2$ where $t_1 \equiv \existype{x}{t_x}{t'}$. By inversion for some $y \not\in\dom{\Gamma}$ such that $y \not\in{\rm free}(t_2)$ we have 
$y\bind t_x,\Gamma \vdash t'[y/x] <: t_2$. Then by the inductive hypothesis  $\lfloor t_2 \rfloor \overset{\al}{=} \lfloor t'[y/x] \rfloor = \lfloor t' \rfloor = \lfloor \existype{x}{t_x}{t'} \rfloor$.

{\bf Case} {\sc Sub-Poly}: We have $t_1 \equiv \polytype{\al_1}{k}{t'_1}$ and $t_2 \equiv \polytype{\al_2}{k}{t'_2}$. By inversion, for some $\al\not\in\dom{\Gamma}$, $\al\bind k,\Gamma \vdash t'_1[\al/\al_1] <: t'_2[\al/\al_2]$. By the inductive hypothesis we have
$\lfloor t'_1 \rfloor [\al/\al_1] = \lfloor t'_1[\al/\al_1] \rfloor
\overset{\al}{=} \lfloor t'_2[\al/\al_2] \rfloor = \lfloor t'_2 \rfloor [\al/\al_2].$ Thus under an additional alpha-equivalence, $\lfloor \polytype{\al_1}{k}{t'_1} \rfloor \overset{\al}{=} \lfloor \polytype{\al_2}{k}{t'_2} \rfloor$.
\end{proof}

Our proof of the soundness theorems begin with several helping lemmas.

\begin{lemma}{(Selfification and Denotations) If $\varnothing \vdash_w t : k$ %and $\varnothing \vdash_B e : \lfloor t \rfloor$
and if %$\theta\in\lb\Gamma\rb$ such that $\theta(e) \many 
$e\many v$ such that $v \in \lb t\rb$ then $v \in \lb {\rm self}(t,e)\rb$.} \label{self-denote}
\end{lemma}
\begin{proof} 
We observe that $\lfloor {\rm self}(t,e)\rfloor = \lfloor t \rfloor$ so $\varnothing\vdash_B v : \lfloor {\rm self}(t,e)\rfloor$ if and only if $\varnothing\vdash_B v : \lfloor t \rfloor$. Also $\varnothing \vdash_B e : \lfloor t \rfloor$ by the preservation theorem for System F. We now proceed by structural induction on $t$.  

In the first case, $t \equiv b\{z\col p\}$ and ${\rm self}(t, e) = b\{z \col p \wedge z = e\}$. By hypothesis, $v \in \lb t\rb$ so $\varnothing \vdash_B v : b$ and $p[v/z] \many \true$.
Then we also have that $(p \wedge z = e)[v/z] = (p[v/z] \wedge v=e) \many (\true\wedge v=e) \many (\true\wedge v=v) \many \true$.
%Then $\theta({\rm self}(t, e)) = b\{z\col \theta(p) \wedge z = \theta(e)\}$. We have $\theta(p\wedge z = e)[\theta(e)/z] = (\theta(p)[\theta(e)/z] \wedge \theta(e)=\theta(e)) \many \true$ because $\theta(p)[\theta(e)/z] \many \true$ from $\theta(x)\in\lb b\{z\col \theta(p)\}\rb.$ Therefore $\theta(x) \in \lb\theta({\rm self}(t,x))\rb$, as desired.
Therefore $v \in \lb{\rm self}(t,e)\rb$, as desired.

Second, if $t\equiv \existype{y}{s_y}{s}$ then
\[ 
\lb{\rm self}(t,e)\rb = \{\hat v \,|\, \varnothing \vdash_B \hat v : \lfloor {\rm self}(s,e) \rfloor \;\wedge\; (\exists\, v_y \in \lb s_y\rb.\, \hat v\in \lb {\rm self}(s,e)[v_y/y] \rb ) \}
\]
We do have $v \in \lb\existype{y}{s_y}{s}\rb$, so there exists $v_y \in \lb s_y\rb$ such that $v \in \lb s[v_y/y]\rb$. Then by the inductive hypothesis $v \in \lb {\rm self}(s[v_y/y],e)\rb = \lb {\rm self}(s[v_y/y],e[v_y/y])\rb = \lb{\rm self}(s,e)[v_y/y]$ where we again use the fact that $e = e[v_y/y]$ because $e$ is typed in the empty environment and so cannot have free variables. Thus $v\in \lb{\rm self}(t,e)\rb$.

In the remaining cases, self$(t,e) = t$ and the lemma holds trivially.
\end{proof}

\begin{lemma}{(Type Denotations) Our typing and subtyping relations are sound with respect to the denotational semantics of our types:\\
1. If $\Gamma \vdash t_1 <: t_2$ then $\forall \theta. \theta \in \lb \Gamma \rb \Rightarrow \lb\theta(t_1)\rb \subseteq \lb\theta(t_2)\rb$.\\
2. If $\Gamma \vdash e : t$ %and $e$ reduces to a value $e\many v$
, then $\forall \theta. \theta \in \lb \Gamma \rb \Rightarrow \theta(e) \many v'$ such that $v' \in \lb\theta(t)\rb.$
}\label{type-denote}
\end{lemma}

The proof is by mutual induction on the derivation trees of the respective subtyping and typing judgements. The need for mutual induction contrasts with Lemma 4 of [VSJ$^+$14] and comes from the appearance of the typing judgement $\Gamma \vdash v_x : t_x $ in the antecedent of rule {\sc S-Witn}.
     
\begin{proof} 
(1) Suppose $\Gamma \vdash t_1 <: t_2$. We proceed by induction on the derivation tree of the subtyping relation.

{\bf Case} $\textsc{Sub-Base}$: We have that 
$\Gamma \vdash b\{x_1\col p_1\} <: b\{x_2\col p_2\}$ where $t_1 \equiv b\{x_1\col p_1\}$ and $t_2 \equiv b\{x_2\col p_2\}$.
By inversion, for some $y\not\in\dom{\Gamma}$ we have  
\[ y\bind b\{x_1\col p_1\}, \Gamma \vdash_e  p_2[y/x_2].\] 
By inversion of {\sc Ent-Pred} we have 
\begin{equation}\label{3.1.0}
\forall\,\theta'.\,\theta'\in\lb y\bind b\{x_1\col p_1\}, \Gamma \rb \Rightarrow \theta'(p_2[y/x_2]) \many \true.
\end{equation}
We need to show $\forall \theta.\; 
\theta \in \lb \Gamma \rb \Rightarrow 
\lb\theta(b\{x_1:p_1\})\rb \subseteq \lb\theta(b\{x_2:p_2\})\rb.$
Equivalently,
\begin{align}\label{3.1.1}
\forall\theta.\,\theta\in\lb\Gamma\rb \Rightarrow&
\{ v \,|\, \varnothing \vdash_B v:b \;\wedge\; 
  (\theta(p_1[v/x_1]) \many \true)\}\\
\subseteq &\{ v \,|\, \varnothing \vdash_B v:b \;\wedge\; 
  (\theta(p_2[v/x_2]) \many \true)\}\label{3.1.2}
\end{align}
Let $\theta \in \lb\Gamma\rb$ be a closing substitution and
let $v$ a term in $\lb\theta(t_1)\rb$. 
Then $\theta(t_1) = b\{x_1\col \theta(p_1)\}$ and $\theta(p_1[v/x_1]) \many \true$.
Let $\theta' = (y \mapsto v, \theta) \in \lb y\bind b\{ x_1\col p_1\}, \Gamma\rb$.
By (\ref{3.1.0}) we have
$ \theta'(p_2[y/x_2]) \many \true$ and $\theta'(p_2[y/x_2]) = \theta(p_2[y/x_2][v/y]) = \theta(p_2[v/x_2])$,
which proves $v \in \lb\theta(t_2)\rb$.

{\bf Case} $\textsc{Sub-Func}$: We have that
$\Gamma \vdash x_1\bind s_1 \rightarrow t'_1 <: x_2\bind s_2 \rightarrow t'_2$ where $t_1 \equiv x_1\bind s_1 \rightarrow t'_1$ and $t_2 \equiv x_2\bind s_2 \rightarrow t'_2$. By inversion of this rule, for some $y\not\in\dom{\Gamma}$,
\[
\Gamma \vdash s_2 <: s_1 \;\;\;\;{\rm and}\;\;\;\;
y\bind s_2, \Gamma \vdash t'_1[y/x_1] <: t'_2[y/x_2]
\]
By the inductive hypothesis,
\[
\forall\theta.\, \theta \in \lb\Gamma\rb \Rightarrow
\lb\theta(s_2)\rb \subseteq\lb\theta(s_1)\rb 
\]
and
\begin{equation}\label{3.2.0}
\forall\theta'.\, \theta' \in \lb y\bind s_2,\Gamma\rb \Rightarrow
\lb\theta'(t'_1[y/x_1])\rb \subseteq\lb\theta'(t'_2[y/x_2])\rb 
\end{equation}
We need to show $\forall \theta.\; 
\theta \in \lb \Gamma \rb \Rightarrow 
\lb\theta(x_1\bind s_1\rightarrow t'_1)\rb \subseteq \lb\theta(x_2\bind s_2\rightarrow t'_2)\rb.$
Equivalently,
\begin{align} \label{3.2.1}
\forall\theta.\,\theta\in\lb\Gamma\rb \Rightarrow&
\{ v \,|\, \varnothing \vdash_B v:\lfloor \theta(s_1)\rfloor \rightarrow \lfloor \theta(t'_1)\rfloor \;\wedge\; 
  (\forall\, v' \in \lb \theta(s_1)\rb.\, v\,v' \many v^* \in\lb \theta(t'_1)[v'/x_1]\rb)\}\\
\subseteq &\{ v \,|\, \varnothing \vdash_B v:\lfloor \theta(s_2)\rfloor \rightarrow \lfloor \theta(t'_2)\rfloor \;\wedge\; 
  (\forall\, v' \in \lb \theta(s_2)\rb.\, v\,v' \many v^* \in\lb \theta(t'_2)[v'/x_2]\rb)\}\label{3.2.2} 
\end{align}
Fix $\theta \in \lb\Gamma\rb$ and let $v$ be a term in set (\ref{3.2.1}) and let $v' \in \lb \theta(s_2)\rb$. Then by induction, $v' \in \lb \theta(s_1)\rb$. So there exists a value $v^*$ such that $(v\, v') \many v^*$ and $v^* \in \lb(\theta(t'_1)[v'/x_1]\rb$. Let $\theta' = (y \mapsto v', \theta)$.  From (\ref{3.2.0}) we also have that 
$\lb\theta'(t'_1[y/x_1])\rb \subseteq \lb\theta'(t'_2[y/x_2])\rb$.
But $\theta'(t'_1[y/x_1]) = \theta(t'_1[y/x_1])[v'/y] = \theta(t'_1)[v'/x_1]$ and $\theta'(t'_2[y/x_2]) = \theta(t'_2)[v'/x_2]$.
Therefore  $v^* \in \lb \theta(t'_1)[v'/x_2]\rb \subseteq \lb \theta(t'_2)[v'/x_2]\rb$ and so $v$ is in set (\ref{3.2.2}) as desired.
Finally, given $\varnothing \vdash_B v:\lfloor \theta(s_1)\rfloor \rightarrow \lfloor \theta(t'_1)\rfloor$ we have $\varnothing \vdash_B v:\lfloor \theta(s_2)\rfloor \rightarrow \lfloor \theta(t'_2)\rfloor$ by Lemma \ref{sub-erase}.

{\bf Case} $\textsc{Sub-Witn}$: We have that
$\Gamma \vdash t_1 <: \exists\, x\bind t_x.\, t'_2$ where $t_2 \equiv \exists\, x\bind t_x.\, t'_2$. By inversion, there exists some value term $v_x$ such that
\[
\Gamma \vdash v_x : t_x \quad {\rm and} \quad \Gamma \vdash t_1 <: t'_2[v_x/x].
\]
By the inductive hypothesis, we have 
\begin{equation}\label{3.3.1}
\forall\, \theta.\, \theta\in \lb\Gamma\rb \Rightarrow \lb \theta(t_1) \rb \subseteq \lb \theta(t'_2[v_x/x]) \rb 
\end{equation}
and by mutual induction we also have that there exists a value $v'$ such that
\[
\forall\, \theta.\, \theta\in \lb\Gamma\rb \Rightarrow \theta(v_x) \many v' \in \lb\theta(t_x)\rb;
\]
values are closed under substitution and cannot be reduced further, so we must have that $v' = \theta(v_x)$.
We need to show that $\forall\, \theta$, if $\theta \in \lb\Gamma\rb$, then $\lb\theta(t_1)\rb \subseteq \lb \theta(\exists\, x\bind t_x.\, t'_2)\rb$. Fix some $\theta \in \lb\Gamma\rb.$ Then
\begin{equation} \label{3.3.2}
\lb \theta(\exists\, x\bind t_x.\, t'_2)\rb
= \{ v \,|\, \varnothing \vdash_B v : \lfloor \theta(t'_2)\rfloor \;\wedge\; 
  (\exists\, v' \in \lb \theta(t_x)\rb.\, v \in\lb \theta(t'_2)[v'/x]\rb)\}
\end{equation}
because $\theta(\exists\, x\bind t_x.\, t'_2) = \exists\, x\bind\theta(t_x).\, \theta(t'_2).$
Let $v \in \lb\theta(t_1)\rb$ and let $v' = \theta(v_x) \in \lb\theta(t_x)\rb$ be as above.
Then by (\ref{3.3.1}), $v \in \lb\theta(t'_2[v_x/x])\rb = \lb\theta(t'_2)[\theta(v_x)/x]\rb = \lb\theta(t'_2)[v'/x]\rb$.
By \ref{3.3.1} and by definition of the denotation of a type, $\varnothing \vdash_B v : \lfloor \theta(t'_2[v_x/x])\rfloor = \lfloor\theta(t'_2)\rfloor$. Therefore $v$ is in the right hand side of (\ref{3.3.2}).

{\bf Case} $\textsc{Sub-Bind}$: We have that $\Gamma \vdash \exists\, x\bind t_x.\, t'_1 <: t_2$ where $t_1 \equiv \exists\, x\bind t_x.\, t'_1$. By inversion we have for some $y \not\in\dom{\Gamma}$
\[
y\bind t_x,\Gamma\vdash t'_1[y/x] <: t_2 \quad {\rm and}\quad y \not\in free(t_2).
\]
By the inductive hypothesis, we have
\begin{equation}
\forall\,\theta'.\, \theta'\in\lb y\bind t_x,\Gamma\rb \Rightarrow \lb\theta'(t'_1[y/x])\rb \subseteq \lb\theta'(t_2)\rb.
\label{3.4.1}	
\end{equation}
We need to show that for every $\theta \in \lb\Gamma\rb$ that it holds that $\lb \theta(\exists\, x\bind t_x.\, t'_1)\rb \subseteq \lb\theta(t_2)\rb$. Fix some $\theta \in \lb\Gamma\rb$ and let $v \in \lb \theta(\exists\, x\bind t_x.\, t'_1)\rb$. By definition, $\theta(\exists\, x\bind t_x.\, t'_1) = \exists\, x\bind \theta(t_x).\, \theta(t'_1)$ so
\begin{equation}\label{3.4.2}
\lb \theta(\existype{x}{t_x}{t'_1})\rb = \{ v \,|\, \varnothing \vdash_B v: \lfloor\theta(t'_1)\rfloor \;\wedge\; (\exists\,v' \in \lb\theta(t_x)\rb.\, v \in \lb\theta(t'_1)[v'/x]\rb)\}.
\end{equation}
Take $v'$ as in (\ref{3.4.2}) and let $\theta' = (y\mapsto v', \theta)$. We note that $\theta' \in \lb y\bind t_x,\Gamma\rb$ because $\theta'(y) = v' \in \lb\theta(t_x)\rb = \lb\theta'(t_x)\rb$ where the last equality follows from the fact that $x$ cannot appear free in $t_x$. Then $v \in \lb\theta(t'_1)[v'/x]\rb = \lb\theta(t'_1[y/x])[v'/y]\rb = \lb\theta'(t'_1[y/x])\rb$, so from (\ref{3.4.1}) we can conclude $v \in \lb\theta'(t_2)\rb = \lb\theta(t_2)\rb$ because $y$ does not appear free in $t_2$ so $\theta'(t_2)=\theta(t_2)$. 

{\bf Case} $\textsc{Sub-Poly}$: We have that
$\Gamma \vdash \polytype{\al_1}{k}{t'_1} <: \polytype{\al_2}{k}{t'_2}$, where $t_1 \equiv \polytype{\al_1}{k}{t'_1}$ and $t_2 \equiv \polytype{\al_2}{k}{t'_2}$.
By inversion, for some $\al\not\in\dom{\Gamma}$, $\al\bind k,\Gamma \vdash t_1[\al/\al_1] <: t_2 [\al/\al_2]$.
By the inductive hypothesis, we have that for all $\theta' \in \lb \al\bind k, \Gamma\rb$ we have 
$\lb \theta'(t_1[\al/\al_1]) \rb \subseteq \lb \theta'( t_2[\al/\al_2] )\rb$.
We need to show \[\forall\theta.\; \theta \in \lb\Gamma\rb \Rightarrow \lb \theta(\polytype{\al_1}{k}{t_1})\rb \subseteq \lb \theta(\polytype{\al_2}{k}{t_2})\rb.\] 
Let $\theta \in \lb\Gamma\rb$ arbitrary and let $v \in \lb\theta( \polytype{\al_1}{k}{t_1})\rb = \lb\polytype{\al_1}{k}{\theta(t_1)}\rb$. Then $\varnothing \vdash_B v : \polytype{\al_1}{k}{\lfloor \theta(t_1) \rfloor}$. By Lemma \ref{erase-sub}, we also have $\varnothing \vdash_B v : \polytype{\al_2}{k}{\lfloor \theta(t_2) \rfloor}$ 
because $\lfloor \theta(t_1[\al/\al_1]\rfloor \overset{\al}{=} \lfloor \theta(t_2[\al/\al_2]) \rfloor$ and $\lfloor \polytype{\al_1}{k}{\theta(t_1)} \rfloor = \lfloor \polytype{\al_2}{k}{\theta(t_2)} \rfloor$. 
Now let $t_\al$ be a type such that $\varnothing \vdash_w t_\al : k$. Then we have that there exists a value $v'$ such that 
$v\, [t_\al] \many v'$ and $v' \in \lb \theta(t_1)[t_\al/\al_1]\rb = \lb\theta(t_1[\al/\al_1])[t_\al/\al]\rb.$
Let $\theta' = (\al \mapsto t_\al, \theta)$. Then $v' \in \lb\theta'(t_1[\al/\al_1])\rb$ and by induction we have
\[
v' \in \lb\theta'(t_2[\al/\al_2])\rb = \lb\theta(t_2[\al/\al_2])[t_\al/\al]\rb = \lb \theta(t_2)[t_\al/\al_2]\rb.
\]
This proves that $v \in \lb\polytype{\al_2}{k}{\theta(t_2)}\rb = \lb\theta(\polytype{\al_2}{k}{t_2})\rb$ as desired.\\



(2) Suppose $\Gamma \vdash e : t$. % and $e \many v$. 
We proceed by induction on the derivation tree of the typing relation. 

{\bf Case} {\sc T-Prim}: We have $\Gamma \vdash e : t$ where $e \equiv c$, a built-in primitive function or constant. By inversion, $ty(c) = t$. Let $\theta \in \lb \Gamma \rb$.
In one case $t \equiv b\{x\col p\}$; then by Lemma \ref{prim-typing} on constants, $\theta(c) = c \in \lb ty(c)\rb = \lb \theta(ty(c))\rb$. In the other case, $ty(c) \equiv \functype{x}{t_x}{t'}$; by Lemma \ref{prim-typing},
$c\; v_x \step \delta(c,v_x) \in \lb t'[v_x/x]\rb$ for any $v_x \in \lb t_x\rb.$ There are no free variables in $c$ or $t$ so $\theta(c)$ is a value and $\theta(c) = c \in \lb ty(c)\rb = \lb\theta(ty(c))\rb$.

{\bf Case} {\sc T-Var}: We have $\Gamma \vdash e : t$ where $e \equiv x$ and $t \equiv {\rm self}(t', x)$. By inversion, $(x\bind t') \in \Gamma$. Then for any $\theta \in \lb\Gamma\rb,$ we have by definition $\theta(x) \in \lb \theta(t')\rb$. 
By Lemma \ref{self-denote}, we have $\theta(x) \in \lb {\rm self}(\theta(t'), \theta(x))\rb = \lb\theta({\rm self}(t',x))\rb = \lb\theta(t)\rb$.

{\bf Case} {\sc T-App}: We have $\Gamma \vdash e : t$ where $e \equiv e'\; e_x$ and $t \equiv \existype{x}{t_x}{t'}$. By inversion,
$\Gamma \vdash e' : \functype{x}{t_x}{t'}$ and $\Gamma \vdash e_x : t_x$. 
By the inductive hypothesis we have both
                                                                                                                                                                                                                                                                                                                                            
\begin{equation}\label{3.8.1}
\forall \theta.\, \theta\in\lb\Gamma\rb \Rightarrow \exists\, v'.\,
\theta(e') \many v' \,{\rm and}\; v' \in \lb\theta(\functype{x}{t_x}{t'})\rb\end{equation}
and
\begin{equation}\label{3.8.2}
\forall \theta.\, \theta \in \lb\Gamma\rb \Rightarrow \exists\, v_x.\,
\theta(e_x) \many v_x \;{\rm and}\; v_x \in \lb\theta(t_x)\rb.
\end{equation}

Fix some $\theta \in \lb\Gamma \rb$ and let $v'$ and $v_x$ be as above; we must show that there exists some value $v$ such that $\theta(e) = \theta(e')\; \theta(e_x) \many v$ and $v \in \lb\theta(t)\rb = \lb\existype{x}{\theta(t_x)}{\theta(t')}\rb$. 
Because $v' \in \lb\theta(\functype{x}{t_x}{t'})\rb =\lb\functype{x}{\theta(t_x)}{\theta(t')}\rb$, we have that $\varnothing \vdash_B v' : \lfloor t_x\rfloor \rightarrow \lfloor t'\rfloor$ and that there exists a $v$ such that $v'\; v_x \many v$ and $v \in \lb \theta(t')[v_x/x]\rb$. Note that $\theta(e) = \theta(e')\; \theta(e_x) \many v'\; v_x \many v$ and we have $\varnothing \vdash_B v'\; v_x : \lfloor t' \rfloor$ because $\varnothing \vdash_B v_x:\lfloor t_x\rfloor$. Then by the soundness of the underlying System F, we have $\varnothing \vdash_B v : \lfloor t' \rfloor$. Thus we conclude that $v \in \lb \existype{x}{\theta(t_x)}{\theta(t')}\rb$ as required.

{\bf Case} {\sc T-Abs}: We have $\Gamma \vdash e : t$ where $e \equiv \lambda x.e'$ and $t \equiv \functype{x}{t_x}{t'}$. By inversion, there exists some $y\not\in\dom{\Gamma}$ such that $y\bind t_x, \Gamma \vdash e'[y/x] : t'[y/x]$. By the inductive hypothesis,
\begin{equation}\label{3.7.1}
\forall\theta'.\, \theta' \in \lb y\bind t_x,\Gamma\rb \Rightarrow \exists\, v'.\, \theta'(e'[y/x]) \many v' \;{\rm and}\; v' \in \lb\theta'(t'[y/x])\rb.\end{equation}
We need to show that for every $\theta \in \lb\Gamma\rb$, there exists a value $v$ such that $\theta(e) \many v$ and 
\begin{align*}
v \in \lb \theta(&\functype{x}{t_x}{t'}) \rb = \lb \functype{x}{\theta(t_x)}{\theta(t')}\rb\\
=&\; \{ \hat{v} \;|\; (\varnothing \vdash_B {\hat v} : \lfloor \theta(t_x) \rfloor \rightarrow \lfloor \theta(t') \rfloor) \wedge ( \forall\, v_x \in \lb \theta(t_x) \rb.\; \exists v'.\,\hat v \; v_x \many v' \in \lb\theta(t')[v_x/x] \rb) \}
\end{align*}

Let $\theta \in \lb\Gamma\rb$ and let $v = \lambda x.\theta(e') = \theta(e)$. By repeated application of the substitution lemma for System F, $\varnothing \vdash_B v : \lfloor \theta(t) \rfloor$.
Let $v_x \in \lb \theta(t_x)\rb$ a value.  Then let
\[\theta' := (y\mapsto v_x, \theta) \in \lb y\bind t_x,\Gamma\rb.\] 
By rule {\sc E-AppAbs} $v\; v_x \step \theta(e')[v_x/x] = \theta(e'[y/x])[v_x/y] = \theta'(e'[y/x]) \many v'$ and $v' \in \lb\theta'(t'[y/x])\rb = \lb \theta(t')[v_x/x]\rb$ by (\ref{3.7.1}), which proves that $v \in \lb\theta(t)\rb$.

{\bf Case} {\sc T-AppT} We have $\Gamma \vdash e : t$ where $e \equiv e'\; [t']$ and $t \equiv s[t'/\al]$. By inversion, $\Gamma \vdash e' : \polytype{\al}{k}{s}$ and $\Gamma \vdash_w t': k$. By the inductive hypothesis
\begin{equation}\label{3.16}
\forall\, \theta.\, \theta \in \lb\Gamma\rb \Rightarrow \exists v'.\, \theta(e') \many v' \;{\rm and}\; v' \in \lb\polytype{\al}{k}{\theta(s)}\rb.
\end{equation}
Let $\theta \in \lb\Gamma\rb$. Then $\theta(e) = \theta(e')\; [\theta(t')] \many v'\; [\theta(t')]$. By definition of a denotation, we have that there exists $v''$ such that $v'\; [\theta(t')] \many v''$ and $v'' \in \lb \theta(s)[\theta(t')/\al]\rb = \lb\theta(t)\rb$.

{\bf Case} {\sc T-AbsT}. We have $\Gamma \vdash e : t$ where $e \equiv \Lambda \al\bind k. e'$ and $t \equiv \polytype{\al}{k}{t'}$. By inversion we have that there exists $\al' \not\in\dom{\Gamma}$ such that $\al'\bind k, \Gamma \vdash e'[\al'/\al] : t'[\al'/\al]$, and by the inductive hypothesis,
\begin{equation}\label{3.15}
\forall\, \theta'.\, \theta' \in \lb\al'\bind k, \Gamma\rb \Rightarrow
\exists v'.\, \theta'(e'[\al'/\al]) \many v' \;{\rm and}\; v' \in \lb\theta'(t'[\al'/\al])\rb.
\end{equation}
Let $\theta \in \lb\Gamma\rb$ arbitrary and let $t_\al$ be a type such that $\varnothing \vdash_w t_\al : k$. Then we have $\theta' := (\al' \mapsto t_\al, \theta).$ 
Let $v = \Lambda\al\bind k.\theta(e')$.
Then from (\ref{3.15}), we have that $v'$ exists such that
\[
v\; [t_\al] \step \theta(e')[t_\al/\al] = \theta(e'[\al'/\al])[t_\al/\al'] = \theta'(e'[\al'/\al]) \many v'
\]
and $v' \in \lb\theta'(t'[\al'/\al])\rb = \lb\theta(t')[t_\al/\al]\rb.$
Finally, by repeated application of the System F substitution lemma, $\varnothing \vdash_B c : \lfloor \theta(t)\rfloor$. This proves that $v \in \lb \theta(t)\rb$.

{\bf Case} {\sc T-Let}: We have $\Gamma \vdash e : t$ where
$e \equiv \letin{x}{e_x}{e'}$.
By inversion, we have for some $y\not\in\dom{\Gamma}$, that
$\Gamma \vdash e_x : t_x$,\; $(y\bind t_x,\Gamma) \vdash e'[y/x] : t[y/x]$, and $\Gamma \vdash_w t$
for some $t_x$. Then by the inductive hypothesis we have
\[
\foralltheta \Rightarrow \exists v_x.\, \theta(e_x) \many v_x \;{\rm and}\; v_x \in \lb\theta(t_x)\rb
\] and 
\begin{equation}\label{3.9.1}
\forall\theta'.\, \theta' \in \lb y\bind t_x, \Gamma\rb \Rightarrow \exists v'.\, \theta'(e'[y/x]) \many v' \;{\rm and}\; v' \in \lb\theta'(t[y/x])\rb.
\end{equation}
Let $\theta \in \lb\Gamma\rb$. Let $v_x$ be as above and let $\theta' = (y\mapsto v_x, \theta)\in \lb y\bind t_x,\Gamma\rb$ because we chose $\theta'(x) = v_x \in \lb\theta(t_x)\rb$. 
From the operational semantics $\theta(\letin{x}{e_x}{e'}) = (\letin{x}{\theta(e_x)}{\theta(e')}) \many (\letin{x}{v_x}{\theta(e')}) \step \theta(e')[v_x/x] = \theta(e'[y/x])[v_x/y] = \theta'(e'[y/x]) \many v'$ for some value $v'$.
 Then from (\ref{3.9.1}),
\[
v' \in \lb\theta'(t[y/x])\rb = \lb\theta(t[y/x])[v_x/y]\rb = \lb\theta(t[y/x])\rb,
\]
where the last equality follows from the fact that the judgment $\Gamma \vdash_w t$ implies that $y$ cannot be free in $\theta(t)$.
In conclusion we have $\theta(e) \many v'$ and $v' \in \lb\theta(t[y/x])\rb$ as required.

{\bf Case} {\sc T-Ann}: We have $\Gamma \vdash e : t$ where $e \equiv (e'\col t)$. By inversion, $\Gamma \vdash e' : t$ and by the inductive hypothesis, there exists some value $v$ such that $\theta(e') \many v$ and $v \in \lb\theta(t)\rb$. 
By the operational semantics of type annotations, $\theta(e) = (\theta(e')\col \theta(t)) \many (v\col \theta(t)) \step v \in \lb\theta(t)\rb$, as required. 

{\bf Case} {\sc T-Sub}: We have $\Gamma \vdash e : t $ and by inversion, we have $\Gamma \vdash e : s$ and $\Gamma \vdash s <: t$ for some type $s$. By the inductive hypothesis, 
$\foralltheta \Rightarrow \exists v.\, \theta(e) \many v \;{\rm and}\; v\in \lb\theta(s)\rb$. By mutual induction, part 1 of the Lemma gives us that $\foralltheta \Rightarrow \lb\theta(s)\rb \subseteq \lb\theta(t)\rb$.
Then we conclude that $\foralltheta \Rightarrow \exists v.\, \theta(e) \many v \;{\rm and}\; \in \lb\theta(t)\rb$ as desired.
\end{proof}

\begin{lemma}(Exactness)\label{exactness} The self$()$ function satisfies the following properties:\\
1. We have both $\Gamma\vdash {\rm self}(t,e) <: {\rm self}({\rm self}(t,e),e)$ and $\Gamma\vdash {\rm self}({\rm self}(t,e),e) <: {\rm self}(t,e)$.\\
2. If $\Gamma \vdash s <: t$ and $\Gamma\vdash e : t_e$ then $\Gamma \vdash {\rm self}(s,e) <: {\rm self}(t,e)$. \\
3. If $\Gamma \vdash v : t$ then $\Gamma \vdash v : {\rm self}(t,v)$.
\end{lemma}
\begin{proof}
(1) The first subtyping judgment follows from the fact that ${\rm self}(t',e) <: t'$ holds for any type $t'$; in particular, set $t' \equiv {\rm self}(t,e)$. The second judgment follows (by induction on $t$) from the fact for any predicate $p$ we have $\Gamma \vdash b\{x_1\col p \wedge x_1 = e \wedge x_1 = e\} <: b\{x_1\col p \wedge x_1 = e\}$.

(2) We proceed by induction on the judgment $\Gamma\vdash s <: t$.

{\bf Case} {\sc S-Base}: We have $s\equiv b\{x_1\col p_1\}$ and $t\equiv b\{x_2\col p_2\}$. By inversion $y\bind b\{x_1\col p_1\},\Gamma \vdash_e p_2[y/x_2]$ for some $y\not\in\dom{\Gamma}$. By inversion of {\sc Ent-Pred} we have $\forall \theta.\,\theta\in\lb y\bind b\{x_1\col p_1\},\Gamma \rb \Rightarrow \theta(p_2[y/x_2]) \many \true$. Let $\theta'\in\lb y\bind b\{x_1\col p_1\wedge x_1 = e\}, \Gamma\rb.$ Then in particular $\theta'(p_2[y/x_2]) \many \true$. We also have $\theta'(y) = e \many \true$, so $\theta'((p_2 \wedge x_2 = e)[y/x_2]) \many \true$ and thus $y\bind b\{x_1\col p_1 \wedge x_1 = e\},\Gamma \vdash_e (p_2 \wedge x_2 = e)[y/x_2]$ by rule {\sc Ent-Pred}. Then by rule {\sc S-Base} we conclude that $\Gamma \vdash b\{x_1\col p_1 \wedge p_1 = e\} <: b\{x_2\col p_2 \wedge p_2=e\}$.

{\bf Case} {\sc S-Func} and {\sc S-Poly}: The cases are trivial because in the former both $s$ and $t$ must be function types and in the latter both $s$ and $t$ must be polymorphic types. In either case self$(s,e)=e$ and self$(t,e) = t$.

{\bf Case} {\sc S-Witn}: We have $\Gamma \vdash s <: t$ where $t\equiv \existype{x}{t_x}{t'}$. By inversion we have $\Gamma \vdash v_x : t_x$ and $\Gamma \vdash s <: t'[v_x/x]$ for some value $v_x$. By the inductive hypothesis, $\Gamma \vdash {\rm self}(s,e) <: {\rm self}(t'[v_x/x], e)$. We have ${\rm self}(t'[v_x/x],e) = {\rm self}(t', e)[v_x/x]$ because $x$ cannot appear free in $e$. Then by rule {\sc S-Witn} we can conclude that $\Gamma \vdash {\rm self}(s,e) <: \existype{x}{t_x}{{\rm self}(t', e)}$, where the latter type is equal to self$(t,e)$ by definition.

{\bf Case} {\sc S-Bind}: We have $\Gamma \vdash s <: t$ where $s \equiv \existype{x}{s_x}{s'}$. By inversion we have $y\bind s_x, \Gamma \vdash s'[y/x] <: t$ for some $y\not\in\dom{\Gamma}$ such that $y\not\in free(t)$. By the inductive hypothesis, $y\bind s_x, \Gamma \vdash {\rm self}(s'[y/x],e) <: {\rm self}(t,e)$. We have ${\rm self}(s'[y/x],e) = {\rm self}(s',e)[y/x]$ because $x$ cannot appear free in $e$. Then by rule {\sc S-Bind} (because $y\not\in\Gamma$ so $y$ cannot appear free in $e$) we have $\Gamma \vdash \existype{s}{s_x}{{\rm self}(s',e)} <: t$.

(3) We proceed by induction on the structure of the judgment $\Gamma \vdash v : t$. Several cases don't apply because $v$ must be a value ({\sc T-App}, {\sc T-AppT}, {\sc T-Let}, and {\sc T-Ann}).

{\bf Case} {\sc T-Prim}: We have $v \equiv c$. If $c$ is a constant then it already has an exact type, that is, $t \equiv {\rm self}(b\{x\col\true\}, c)$ and this follows from part (1). Similarly, for each primitive function the type is already exact.

{\bf Case} {\sc T-Var}: We have $v \equiv x$ and $t \equiv {\rm self}(t',x)$. Then by {\sc T-Sub} and part (1) $\Gamma \vdash v : {\rm self}(t,x)$.

{\bf Case} {\sc T-Abs}: We have $v \equiv \lambda x.\, e'$ and $t\equiv \functype{x}{t_x}{t'}$. We have self$(\functype{x}{t_x}{t'}, v) = \functype{x}{t_x}{t'}$ and so this case follows trivially.

{\bf Case} {\sc T-AbsT}: We have $v \equiv \Lambda \al\bind k.\, e$ and $t \equiv \polytype{\al}{k}{t'}$. We have that self$(\polytype{\al}{k}{t'}, v) = \polytype{\al}{k}{t'}$ and so this case also follow trivially.

{\bf Case} {\sc T-Sub}: Inverting we have $\Gamma \vdash e : s$ and $\Gamma s <: t$. By the inductive hypothesis, $\Gamma \vdash e : {\rm self}(s,e)$. 
\end{proof}

\begin{lemma}(The Substitution Lemma)\label{substitution}
If $\Gamma \vdash v_x : t_x$ and if $\Gamma \vdash_w t_\al : k$ then\\
1. If\; $\Gamma', x\bind t_x, \Gamma \vdash t_1 <: t_2$ and $\vdash_w \Gamma', x\bind t_x, \Gamma$ then
\[
\Gamma'[v_x/x], \Gamma \vdash t_1[v_x/x] <: t_2[v_x/x],
\]
and if\; $\Gamma', \al\bind k, \Gamma \vdash t_1 <: t_2$ and $\vdash_w \Gamma', \al\bind k, \Gamma$ then
\[
\Gamma'[t_\al/\al], \Gamma \vdash t_1[t_\al/\al] <: t_2[t_\al/\al].
\]
2. If\; $\Gamma', x\bind t_x, \Gamma \vdash e : t$ and $\vdash_w \Gamma', x\bind t_x, \Gamma$then
\[
\Gamma'[v_x/x], \Gamma \vdash e[v_x/x] : t[v_x/x],
\]
and if\; $\Gamma', x\bind t_x, \Gamma \vdash e : t$ and $\vdash_w \Gamma', \al\bind k, \Gamma$ then
\[
\Gamma'[t_\al/\al], \Gamma \vdash e[t_\al/\al] : t[t_\al/\al].
\]
3. If\; $\Gamma', x\bind t_x, \Gamma \vdash_w t : k$ and $\vdash_w \Gamma', x\bind t_x, \Gamma$then
\[
\Gamma'[v_x/x], \Gamma \vdash_w t[v_x/x] : k,
\]
and if\; $\Gamma', x\bind t_x, \Gamma \vdash_w t : k$ and $\vdash_w \Gamma', \al\bind k, \Gamma$ then
\[
\Gamma'[t_\al/\al], \Gamma \vdash_w t[t_\al/\al] : k.
\]
\end{lemma}

\begin{proof}
(1) Suppose $\Gamma \vdash v_x:t_x$ and $\Gamma', x\bind t_x ,\Gamma  \vdash t_1 <: t_2$. We proceed by mutual induction (for parts 1 and 2) on the derivation tree of the subtyping relation. The proofs for substitution for a type variable are entirely similar, except where specifically noted.

{\bf Case} $\textsc{Sub-Base}$: First, we have that 
$\Gamma',x\bind t_x,\Gamma \vdash b\{x_1\col p_1\} <: b\{x_2\col p_2\}$ where $t_1 \equiv b\{x_1\col p_1\}$ and $t_2 \equiv b\{x_2\col p_2\}$.
By inversion, for some $y\not\in\dom{\Gamma',x\bind t_x,\Gamma}$ we have
\[y\bind b\{x_1\col p_1\}, \Gamma',x\bind t_x,\Gamma \vdash_e  p_2[y/x_2].\] 
By inversion of {\sc Ent-Pred} we have 
\begin{equation}\label{311}
\forall\theta^*.\, \theta^* \in \lb y\bind b\{x_1\col p_1\}, \Gamma',x\bind t_x,\Gamma \rb \Rightarrow \theta^*(p_2[y/x_2]) \many \true.
\end{equation}
Let $\hat \theta = (y\mapsto v_y,\theta',\theta) \in \lb y\bind\{x_1\col p_1[v_x/x]\},\Gamma'[v_x/x], \Gamma\rb$ arbitrary and let $\theta^* = (y\mapsto v_y, \theta', x \mapsto v_x, \theta) \in \lb y\bind\{ x_1\col p_1\}, \Gamma', x\bind t_x, \Gamma\rb$.
Then $\hat \theta(p_2[v_x/x][y/x_2]) = \hat\theta(p_2[y/x_2])[v_x/x] = \theta^*(p_2[y/x_2]) \many \true$. Then we have that $y\bind\{x_1\col p_1[v_x/x]\},\Gamma'[v_x/x], \Gamma \vdash_e p_2[v_x/x][y/x_2]$
by rule {\sc Ent-Pred}, and $\Gamma'[v_x/x], \Gamma \vdash b\{x_1\col p_1[v_x/x]\} <: b\{x_2\col p_2[v_x/x]\}$ by {\sc Sub-Base}.

{\bf Case} $\textsc{Sub-Func}$: We have that
$\Gamma', x:t_x,\Gamma \vdash x_1:s_1 \rightarrow t'_1 <: x_2:s_2 \rightarrow t'_2$ where $t_1 \equiv x_1:s_1 \rightarrow t'_1$ and $t_2 \equiv x_2:s_2 \rightarrow t'_2$. By inversion, there exists some $y\not\in\dom{\Gamma',x\bind t_x,\Gamma}$ such that
\[
\Gamma',x:t_x,\Gamma \vdash s_2 <: s_1 \;\;\;\;{\rm and}\;\;\;\;
y\bind s_2, \Gamma',x:t_x,\Gamma \vdash t'_1[y/x_1] <: t'_2[y/x_2].
\]
Applying the inductive hypothesis to the above, we get
\begin{equation}\label{321}
\Gamma'[v_x/x],\Gamma \vdash s_2[v_x/x] <: s_1[v_x/x]
\end{equation} 
and
\begin{equation}\label{322}
y\bind s_2[v_x/x],\Gamma'[v_x/x],\Gamma \vdash t'_1[y/x_1][v_x/x] <: t'_2[y/x_2][v_x/x]
\end{equation}
We necessarily have that $x \neq y$ and $v_x$ contains only free variables from $\Gamma$, so
$t'_1[y/x_1][v_x/x] = t'_1[v_x/x][y/x_1]$ and $t'_2[y/x_2][v_x/x] = t'_2[v_x/x][y/x_2]$.
By rule {\sc Sub-Fun} applied to (\ref{321}) and (\ref{322}),
\[
\Gamma'[v_x/x],\Gamma \vdash x_1:s_1[v_x/x] \rightarrow t'_1[v_x/x] <: x_2:s_2[v_x/x] \rightarrow t'_2[v_x/x]
\]
This is the same as 
$\Gamma'[v_x/x],\Gamma \vdash t_1[v_x/x] <: t_2[v_x/x]$.

{\bf Case} {\sc Sub-Witn}: We have that $t_2 \equiv \existype{y}{t_y}{t'}$ and $\Gamma', x:t_x,\Gamma \vdash t_1 <: \existype{y}{t_y}{t'}$. By inversion, there exists some value $v_y$ such that
\begin{equation}
\Gamma', x:t_x,\Gamma \vdash v_y : t_y \;\;\;\;{\rm and}\;\;\;\;
\Gamma', x:t_x,\Gamma \vdash t_1 <: t'[v_y/y].
\end{equation}
By the inductive hypothesis we have that $\Gamma'[v_x/x], \Gamma \vdash t_1[v_x/x] <: t'[v_y/y][v_x/x]$. By our convention that free and bound variables are distinct (and because $v_x$ contains only free variables from $\Gamma$ and $v_y$ contains only free variables from $\Gamma', x\bind t_x,\Gamma$) we have $t'[v_y/y][v_x/x] = t'[v_x/x][v_y[v_x/x]/y]$. By the inductive hypothesis, we also have $\Gamma'[v_x/x], \Gamma \vdash v_y[v_x/x] : t_y[v_x/x]$. Applying rule {\sc Sub-Witn} we have $\Gamma'[v_x/x], \Gamma \vdash t_1[v_x/x] <: \existype{y}{t_y[v_x/x]}{t'[v_x/x]}$ as desired.

{\bf Case} {\sc Sub-Bind}: We have that $t_1 \equiv \existype{y}{t_y}{t}$ and $\Gamma', x:t_x,\Gamma \vdash\existype{y}{t_y}{t} <: t_2$. By inversion, we have for some $z\not\in\dom{\Gamma', x:t_x,\Gamma}$ such that $z\not\in{\rm free}(t_2)$,
\[
z\bind t_y, \Gamma', x:t_x,\Gamma \vdash t[z/y] <: t_2.
\]
By the inductive hypothesis,
\begin{equation}
z\bind t_y[v_x/x], \Gamma'[v_x/x], \Gamma \vdash t[z/y][v_x/x] <: t_2[v_x/x].
\end{equation}
Because $x \neq z$ and $v_x$ contains only free variables from $\Gamma$ we have $t[z/y][v_x/x] = t[v_x/x][z/y]$. Thus we can apply rule {\sc Sub-Bind} to conclude that
$\Gamma'[v_x/x], \Gamma \vdash \existype{y}{t_y[v_x/x]}{t[v_x/x]} <: t_2[v_x/x].$

{\bf Case} $\textsc{Sub-Poly}$: We have that
$\Gamma', x\bind t_x,\Gamma \vdash \polytype{\al_1}{k}{t'_1} <: \polytype{\al_2}{k}{t'_2}$ where $t_1 \equiv \polytype{\al_1}{k}{t'_1}$ and $t_2 \equiv \polytype{\al_2}{k}{t'_2}$. By inversion, there exists some $\al\not\in\dom{\Gamma',x\bind t_x,\Gamma}$ such that
\[
\al\bind k, \Gamma',x:t_x,\Gamma \vdash t'_1[\al/\al_1] <: t'_2[\al/\al_2].
\]
Applying the inductive hypothesis to the above, we get
\begin{equation}\label{sub-poly-2}
\al\bind k,\Gamma'[v_x/x],\Gamma \vdash t'_1[\al/\al_1][v_x/x] <: t'_2[\al/\al_2][v_x/x]
\end{equation}
We necessarily have that $x \neq \al$ and $v_x$ contains only free variables from $\Gamma$, so
$t'_1[\al/\al_1][v_x/x] = t'_1[v_x/x][\al/\al_1]$ and $t'_2[\al/\al_1][v_x/x] = t'_2[v_x/x][\al/\al_1]$.
By rule {\sc Sub-Fun} applied to (\ref{sub-poly-2}),
\[
\Gamma'[v_x/x],\Gamma \vdash \polytype{\al_1}{k}{t'_1[v_x/x]} <: \polytype{\al_2}{k}{t'_2[v_x/x]}.
\]
This is the same as 
$\Gamma'[v_x/x],\Gamma \vdash t_1[v_x/x] <: t_2[v_x/x]$. \\

(2) Suppose $\Gamma \vdash v_x:t_x$ and $\Gamma', x:t_x ,\Gamma \vdash e : t$. We proceed by induction on the derivation tree of the typing judgment $e:t$. The proofs for substitution of a type variable are entirely similar, except where specifically noted.

{\bf Case} {\sc T-Prim}: We have $\Gamma', x:t_x,\Gamma \vdash e : t$ where $e \equiv c$. By inversion, $t = ty(c)$. By Lemma \ref{prim-typing}, neither $c$ nor $ty(c)$ contain any free variables so $c[v_x/x] = c$ and $ty(c)[v_x/x] = ty(c)$.
By rule {\sc T-Prim},
$\Gamma'[v_x/x],\Gamma \vdash c : ty(c)$ 
because the environment can be arbitrary,
and so
$\Gamma'[v_x/x],\Gamma \vdash c[v_x/x] : ty(c)[v_x/x]$.

{\bf Case} {\sc T-Var}: We have $\Gamma', x:t_x,\Gamma \vdash e : t$ where $e \equiv y$. and $t\equiv {\rm self}(t', y)$. By inversion we have $y\bind t' \in \Gamma', x:t_x,\Gamma.$ There are three possible cases for where $y$ is bound in the environment.

First suppose that $y\bind t' \in \Gamma$. Then, necessarily, $y\neq x$ and $y[v_x/x] = y.$ Now $x\bind t_x$ is bound to the left of $\Gamma$, so $x$ cannot appear free in $t'$ and $t' = t'[v_x/x]$. By rule {\sc T-Var} we have $\Gamma'[v_x/x], \Gamma \vdash y : {\rm self}(t',y)$ and so $\Gamma'[v_x/x], \Gamma \vdash y[v_x/x] : {\rm self}(t',y)[v_x/x] $.

Next suppose $y = x$. Then $t' = t_x$. Also, $x$ cannot appear in $t_x$ (i.e. $x$ cannot be free in its own type). So $t_x = t_x[v_x/x] = t'[v_x/x]$. We also have $v_x = x[v_x/x] = y[v_x/x]$.
By hypothesis, $\Gamma \vdash v_x : t_x$ and by Lemma \ref{weakenings} this judgment remains true with respect to more bindings on variables that don't appear in $\Gamma$; thus $\Gamma'[v_x/x], \Gamma \vdash v_x : t_x$. By Lemma \ref{exactness} we have $\Gamma'[v_x/x],\Gamma\vdash v_x : {\rm self}(t_x,v_x)$.
Then we conclude $\Gamma'[v_x/x], \Gamma \vdash y[v_x/x] : {\rm self}(t',y)[v_x/x]$.

Finally, suppose  $y\bind t \in \Gamma'$. Then $y\bind t[v_x/x] \in \Gamma'[v_x/x]$, and by rule {\sc T-Var} we have $\Gamma'[v_x/x], \Gamma \vdash y : t[v_x/x]$. We must have that $y\neq x$ and thus $y[v_x/x] = y$. Thus we conclude that $\Gamma'[v_x/x], \Gamma \vdash y[v_x/x] : t[v_x/x]$.

For the type variable substitution proof, we have $\Gamma', \al:k,\Gamma \vdash y : t$ and $\vdash_w \Gamma', \al:k,\Gamma$. By inversion we have $y\bind t \in \Gamma', \al;k ,\Gamma.$ We proceed as above, except that there are only two cases: $y\bind t \in \Gamma$ or $y\bind t \in \Gamma'$.

{\bf Case} {\sc T-App}:We have $\Gamma', x\bind t_x,\Gamma \vdash e : t$ where $e \equiv e_1\; e_2$ and $t \equiv \existype{y}{t_y}{t'}$. 
By inversion, $\Gamma', x\bind t_x, \Gamma \vdash e_1 : \functype{y}{t_y}{t'}$ and $\Gamma', x\bind t_x, \Gamma \vdash e_2 : t_y$. By the inductive hypothesis,
\begin{equation}\label{361}
\Gamma'[v_x/x],\Gamma\vdash e_1[v_x/x] : \functype{y}{t_y[v_x/x]}{t'[v_x/x]}
\end{equation}
and
\begin{equation}\label{362}
\Gamma'[v_x/x],\Gamma\vdash e_2[v_x/x] : t_y[v_x/x].
\end{equation}
By applying rule {\sc T-App}
\begin{equation}
\Gamma'[v_x/x],\Gamma\vdash e_1[v_x/x]\;e_2[v_x/x] : \functype{y}{t_y[v_x/x]}{t'[v_x/x]}.
\end{equation}
Now by the definition of substitution we have $e_1[v_x/x]\; e_2[v_x/x] = (e_1\;e_2)[v_x/x] \equiv e[v_x/x]$ and $\functype{y}{t_y[v_x/x]}{t'[v_x/x]} = (\functype{y}{t_y}{t'})[v_x/x] \equiv t[v_x/x]$. Therefore, we conclude that
$\Gamma'[v_x/x],\Gamma \vdash e[v_x/x] : t[v_x/x]$.

{\bf Case} {\sc T-Abs}:We have $\Gamma', x:t_x,\Gamma \vdash e : t$ where $e \equiv \lambda y. e'$ and $t \equiv \functype{y}{t_y}{t'}$. By inversion, $z\bind t_y, \Gamma', x\bind t_x,\Gamma \vdash e'[z/y] : t'[z/y]$ and $\Gamma', x\bind  t_x,\Gamma \vdash_w t_y : k_y$ for some $z\not\in\dom{\Gamma}$. By the inductive hypothesis
\begin{equation}
z\bind t_y[v_x/x], \Gamma'[v_x/x],\Gamma \vdash e'[z/y][v_x/x] : t'[z/y][v_x/x] \;\;{\rm and}\;\; \Gamma'[v_x/x],\Gamma \vdash_w t_y[v_x/x] : k_y.
\end{equation}
We must have $x\neq z$ and we have $x \neq y$ because bound and free variables are taken to be distinct. Moreover, $v_x$ contains only free variables from $\Gamma$, so $e'[z/y][v_x/x] = e'[v_x/x][z/y]$ and $t'[z/y][v_x/x] = t'[v_x/x][z/y]$. Then by rule {\sc T-Abs}
\begin{equation}
\Gamma'[v_x/x], \Gamma' \vdash \lambda y.(e'[v_x/x]) : \functype{y}{t_y[v_x/x]}{t'[v_x/x]}.
\end{equation}
By definition of substitution, we can rewrite the above as
\[
\Gamma'[v_x/x],\Gamma \vdash (\lambda y.e')[v_x/x] : \functype{y}{t_y}{t'}[v_x/x].
\]

{\bf Case} {\sc T-AppT}:We have $\Gamma', x\bind t_x,\Gamma \vdash e : t$ where $e \equiv e'\; [t']$ and $t \equiv s[t'/\al']$. 
By inversion, $\Gamma', x\bind t_x, \Gamma \vdash e' : \polytype{\al'}{k'}{s}$ and $\Gamma', x\bind t_x, \Gamma \vdash_w t' : k'$. By the inductive hypothesis,
\begin{equation}\label{361T}
\Gamma'[v_x/x],\Gamma\vdash e'[v_x/x] : \polytype{\al'}{k'}{s[v_x/x]}
\end{equation}
and
\begin{equation}\label{362T}
\Gamma'[v_x/x],\Gamma\vdash_w t'[v_x/x] : k'.
\end{equation}
By applying rule {\sc T-AppT}
\begin{equation}
\Gamma'[v_x/x],\Gamma\vdash e'[v_x/x]\;[t'[v_x/x]] : s[v_x/x][t'[v_x/x]/\al'].
\end{equation}
Now by the definition of substitution we have $e'[v_x/x]\; [t'[v_x/x]] = (e'\;[t'])[v_x/x] \equiv e[v_x/x]$ and $s[v_x/x][t'[v_x/x]/\al'] = s[t'/\al'][v_x/x] \equiv t[v_x/x]$. Therefore, we conclude that $\Gamma'[v_x/x],\Gamma \vdash e[v_x/x] : t[v_x/x]$.

{\bf Case} {\sc T-AbsT}:We have $\Gamma', x:t_x,\Gamma \vdash e : t$ where $e \equiv \Lambda \al:k. e'$ and $t \equiv \polytype{\al}{k}{t'}$. By inversion, $\al'\bind k, \Gamma', x\bind t_x,\Gamma \vdash e'[\al'/\al] : t'[\al'/\al]$ and $\al'\bind k, \Gamma', x\bind t_x,\Gamma \vdash_w t'[\al'/\al] : k'$ for some $\al'\not\in\dom{\Gamma}$. By the inductive hypothesis
\begin{equation}
\al'\bind k, \Gamma'[v_x/x],\Gamma \vdash e'[\al'/\al][v_x/x] : t'[\al'/\al][v_x/x] \;\;{\rm and}\;\; \al'\bind k, \Gamma'[v_x/x],\Gamma \vdash_w t'[\al'/\al][v_x/x] : k'.
\end{equation}
We must have $x\neq \al'$ and we have $x \neq \al$ because bound and free variables are taken to be distinct. Moreover, $v_x$ contains only free variables from $\Gamma$, so $e'[\al'/\al][v_x/x] = e'[v_x/x][\al'/\al]$ and $t'[\al'/\al][v_x/x] = t'[v_x/x][\al'/\al]$. Then by rule {\sc T-AbsT}
\begin{equation}
\Gamma'[v_x/x], \Gamma' \vdash \Lambda \al:k.(e'[v_x/x]) : \polytype{\al}{k}{t'[v_x/x]}.
\end{equation}
By definition of substitution, we can rewrite the above as
\[
\Gamma'[v_x/x],\Gamma \vdash (\Lambda \al:k.e')[v_x/x] : \polytype{\al}{k}{t'}[v_x/x].
\]
In the type variable substitution lemma, where we have an environment $\Gamma',\beta\bind k_\beta,\Gamma$ and $\Gamma \vdash_w t_\beta : k_\beta$ this proof is similar except that we argue that $e'[\al'/\al][t_\beta/\beta] = e'[t_\beta/\beta][\al'/\al]$ and $t'[\al'/\al][t_\beta/\beta] = t'[t_\beta/\beta][\al'/\al]$ because $\al'\neq\beta$ and only free variables from $\Gamma$ may appear in $t_\beta$.

{\bf Case} {\sc T-Let}: We have $\Gamma', x\bind t_x,\Gamma \vdash e : t$ where $e \equiv (\letin{y}{e_1}{e_2})$ and $t \equiv t_2$. By inversion, $\Gamma', x\bind t_x,\Gamma \vdash e_1 : t_1$ and $z\bind t_1, \Gamma,x\bind t_x,\Gamma \vdash e_2[z/y] : t_2[z/y]$ for some type $t_1$ and some $y\not\in\dom{\Gamma}$. By the inductive hypothesis we have
\begin{equation}
\Gamma'[v_x/x],\Gamma \vdash e_1[v_x/x] : t_1[v_x/x]
\end{equation} and
\begin{equation}
y\bind t_1[v_x/x], \Gamma'[v_x/x], \Gamma \vdash e_2[z/y][v_x/x] : t_2[z/y][e_x/x]
\end{equation}
We must have $x\neq z$ and we have $x \neq y$ because bound and free variables are taken to be distinct. Moreover, $v_x$ contains only free variables from $\Gamma$, so $e_2[z/y][v_x/x] = e_2[v_x/x][z/y]$ and $t_2[z/y][v_x/x] = t_2[v_x/x][z/y]$. Then by rule {\sc T-Let},
\begin{equation}
\Gamma'[v_x/x], \Gamma \vdash \letin{y}{e_1[v_x/x]}{e_2[v_x/x]} : t_2[v_x/x]
\end{equation} which we can write as \[
\Gamma'[v_x/x], \Gamma \vdash (\letin{y}{e_1}{e_2})[v_x/x]:t_2[v_x/x].
\] 

{\bf Case} {\sc T-Ann}: We have $\Gamma', x\bind t_x,\Gamma \vdash e : t$ where $e \equiv (e':t)$. By inversion, we have $\Gamma', x\bind t_x,\Gamma \vdash e' : t$ and by the inductive hypothesis, $\Gamma'[v_x/x],\Gamma \vdash e'[v_x/x] : t[v_x/x]$. By rule {\sc T-Ann}, we get
\begin{equation}\label{351}
\Gamma'[v_x/x], \Gamma \vdash (e'[v_x/x] : t[v_x/x]) : t[v_x/x]
\end{equation}
By definition of substitution, $(e'[v_x/x] : t[v_x/x]) = (e':t)[v_x/x] = e[v_x/x]$, so from (\ref{351}) we immediately get $\Gamma'[v_x/x], \Gamma \vdash e[v_x/x] : t[v_x/x]$.

{\bf Case} {\sc T-Sub}: We have $\Gamma', x\bind t_x,\Gamma \vdash e : t$. By inversion, we have $\Gamma',x\bind t_x,\Gamma \vdash e : s$,\; $\Gamma', x\bind t_x, \Gamma \vdash s <: t$, and $\Gamma',x\bind t_x,\Gamma \vdash_w t : k$ for some type $s$ and kind $k$. By the inductive hypothesis we have
\begin{equation} \label{371}
\Gamma'[v_x/x], \Gamma \vdash e[v_x/x] : s[v_x/x]
\end{equation}
and by part (1) of the Lemma we have
\begin{equation} \label{372}
\Gamma'[v_x/x],\Gamma \vdash s[v_x/x] <: t[v_x/x].
\end{equation}
By part (3) of the Lemma we also have $\Gamma'[v_x/x],\Gamma \vdash_w t[v_x/x] : k$. Then by rule {\sc T-Sub} we have $\Gamma'[v_x/x], \Gamma \vdash e[v_x/x] : t[v_x/x]$. \\

(3) Suppose $\Gamma \vdash v_x:t_x$ and $\Gamma', x:t_x ,\Gamma \vdash_w t : k$. We proceed by induction on the derivation tree of the typing judgment $e:t$. The proofs for substitution of a type variable are entirely similar, except where specifically noted.

{\bf Case} {\sc WF-Refn}: We have $\Gamma', x\bind t_x,\Gamma \vdash t: k$ where $t \equiv b\{y\col p\}$ and $k \equiv B$. By inversion we have $z\bind b, \lfloor \Gamma',x\bind t_x,\Gamma\rfloor \vdash_B p[z/y] : \Bool$ for some $z\not\in\dom{\Gamma',x\bind t_x,\Gamma}$. By the Substitution Lemma for System F we have
\[
z\bind b, \lfloor \Gamma', \Gamma\rfloor \vdash_B p[z/y][v_x/x] : \Bool.
\]
We must have $z\neq x$ and $x\neq x$ and $v_x$ contains only free variables from $\Gamma$, so $p[z/y][v_x/x] = p[v_x/x][z/y]$. We also have that $\lfloor \Gamma', \Gamma\rfloor = \lfloor \Gamma'[v_x/x], \Gamma\rfloor$ because all refinements are erased . By rule {\sc WF-Refn} we conclude that $\Gamma'[v_x/x], \Gamma \vdash_w b\{y\col p[v_x/x]\} : B$.

{\bf Case} {\sc WF-Kind}: We have $\Gamma', x\bind t_x,\Gamma \vdash t: *$. By inversion, we have We have $\Gamma', x\bind t_x,\Gamma \vdash t: B$. By the inductive hypothesis, $\Gamma'[v_x/x],\Gamma \vdash t[v_x/x]: B$, and by rule {\sc WF-Kind} we conclude $\Gamma'[v_x/x],\Gamma \vdash t[v_x/x]: *$.

{\bf Case} {\sc WF-Var}: We have $\Gamma', x\bind t_x,\Gamma \vdash \al' : k'$. By inversion we have that $\al'\bind k' \in \Gamma', x\bind t_x,\Gamma$. There are two possibilities for where $\al'$ appears in the environment: either in $\Gamma$ or $\Gamma'$ (we cannot have $\al'=x$ because one is a term variable and one is a type variable). Then $\al' = \al'[v_x/x]$. By rule {\sc WF-Var} we thus have $\Gamma'[v_x/x],\Gamma \vdash_w \al'[v_x/x] : k'$. 

{\bf Case} {\sc WF-Func}: We have $\Gamma', x\bind t_x,\Gamma \vdash t: k$ where $t \equiv \functype{y}{t_y}{t'}$ and $k \equiv *$. By inversion we have 
\begin{equation}
\Gamma', x\bind t_x,\Gamma \vdash_w t_y : k_y \;\;\;\;{\rm and}\;\;\;\; z\bind t_y,\Gamma', x\bind t_x,\Gamma \vdash_w t'[z/y] : k'
\end{equation}
for some $z\not\in\dom{\Gamma', x\bind t_x,\Gamma}$. By the inductive hypothesis on the above,
\begin{equation}
\Gamma'[v_x/x], \Gamma \vdash_w t_y[v_x/x] : k_y \;\;\;\;{\rm and}\;\;\;\;z\bind t_y[v_x/x],\Gamma'[v_x/x], \Gamma \vdash_w t'[z/y][v_x/x] : k'.
\end{equation}
We must have $z \neq x$ and $v_x$ contains only free variables from $\Gamma$ so $t'[z/y][v_x/x] = t'[v_x/x][z/y]$. Then by rule {\sc WF-Func} we conclude $\Gamma'[v_x/x], \Gamma \vdash_w \functype{y}{t_y[v_x/x]}{t'[v_x/x]} : *$ and $\functype{y}{t_y[v_x/x]}{t'[v_x/x]} = (\functype{y}{t_y}{t'})[v_x/x]$.

{\bf Case} {\sc WF-Exis}:  We have $\Gamma', x\bind t_x,\Gamma \vdash t: k$ where $t \equiv \existype{y}{t_y}{t'}$. By inversion we have 
\begin{equation}
\Gamma', x\bind t_x,\Gamma \vdash_w t_y : k_y \;\;\;\;{\rm and}\;\;\;\; z\bind t_y,\Gamma', x\bind t_x,\Gamma \vdash_w t'[z/y] : k'
\end{equation}
for some $z\not\in\dom{\Gamma', x\bind t_x,\Gamma}$. By the inductive hypothesis on the above,
\begin{equation}
\Gamma'[v_x/x], \Gamma \vdash_w t_y[v_x/x] : k_y \;\;\;\;{\rm and}\;\;\;\;z\bind t_y[v_x/x],\Gamma'[v_x/x], \Gamma \vdash_w t'[z/y][v_x/x] : k'.
\end{equation}
We must have $z \neq x$ and $v_x$ contains only free variables from $\Gamma$ so $t'[z/y][v_x/x] = t'[v_x/x][z/y]$. Then by rule {\sc WF-Exis} we conclude $\Gamma'[v_x/x], \Gamma \vdash_w \existype{y}{t_y[v_x/x]}{t'[v_x/x]} : k$ and $\existype{y}{t_y[v_x/x]}{t'[v_x/x]} = (\existype{y}{t_y}{t'})[v_x/x]$.

{\bf Case} {\sc WF-Poly}: We have $\Gamma', x\bind t_x,\Gamma \vdash t: k$ where $t \equiv \polytype{\al}{k'}{t'}$ and $k \equiv *$. By inversion we have $\al'\bind k',\Gamma', x\bind t_x,\Gamma \vdash_w t'[\al'/\al] : k_{t'}$for some $\al'\not\in\dom{\Gamma', x\bind t_x,\Gamma}$. By the inductive hypothesis, $al'\bind k', Gamma'[v_x/x], \Gamma \vdash_w t'[\al'/\al][v_x/x] : k_{t'}$. We must have $x\neq\al'$ and $v_x$ contains only free variables from $\Gamma$ so $t'[\al'/\al][v_x/x] = t'[v_x/x][\al'/\al]$. Then by rule {\sc WF-Poly} we conclude $\Gamma'[v_x/x], \Gamma \vdash_w \polytype{\al}{k'}{t'[v_x/x]} : *$ and $\polytype{\al}{k'}{t'[v_x/x]} = (\polytype{\al}{k'}{t'})[v_x/x]$.

Finally, suppose $\Gamma \vdash_w t_\al : k$ and $\Gamma',\al\bind k,\Gamma \vdash e : t$. We give the proof of {\sc WF-Refn} for type variable substitution because it is slightly different as System F types do contain type variables. 
In this case we have $t \equiv b\{y\col p\}$ and $k \equiv B$. By inversion we have $z\bind b, \lfloor \Gamma',\al\bind k,\Gamma\rfloor \vdash_B p[y/x] : \Bool$ for some $z\not\in\dom{\Gamma',x\bind t_x,\Gamma}$. By the Substitution Lemma for System F we have 
\[
z\bind b, \lfloor \Gamma'[t_\al/\al] , \Gamma\rfloor \vdash_B p[z/y][t_\al/\al] : \Bool.
\]
We must have $z\neq \al$ and $y\neq \al$ and $t_\al$ contains only free variables from $\Gamma$, so $p[z/y][t_\al/\al] = p[t_\al/\al][z/y]$. By rule {\sc WF-Refn} we conclude that $\Gamma'[t_\al/\al], \Gamma \vdash_w b\{y\col p[t_\al/\al]\} : B$.

We also consider the proof of {\sc WF-Var}. Here we have $\Gamma', \al\bind k,\Gamma \vdash \al' : k'$. By inversion we have that $\al'\bind k' \in\Gamma', \al\bind k,\Gamma$. There are three possibilities for where $\al$ appears in the environment. First, consider either $\al'\bind k' \in\Gamma'$ or $\al'\bind k' \in\Gamma$. Then $\al\neq\al'$ so $\al'[t_\al/\al] = \al'$. So we still have $\al'\bind k' \in \Gamma'[t_\al/\al],\Gamma$ and by rule {\sc WF-Var}, $\Gamma'[t_\al/\al],\Gamma \vdash_w \al' : k$. The other possibility is that $\al = \al'$ and $k = k'$ in which case $\al'[t_\al/\al] = t_\al$. By hypothesis $\Gamma \vdash_w t_\al : k$ and by repeated application of Lemma \ref{weakenings} we have $\Gamma'[t_\al/\al], \Gamma \vdash_w t_\al : k$. In other words, $\Gamma'[t_\al/\al], \Gamma \vdash_w \al'[t_\al/\al] : k'$.
\end{proof}

\begin{lemma}\label{types-wf}
(Well-formedness of types in judgments) 
If $\Gamma \vdash e: t$ and $\vdash_{w} \Gamma$ then $\Gamma \vdash_w t : k$ for some kind $k$.
\end{lemma}

\begin{proof} 
We proceed by induction on the derivation tree of the judgment $\Gamma \vdash e : t$.

{\bf Case} {\sc T-Prim}: We have $e \equiv c$. By inversion, $t = ty(c)$ and by Lemma \ref{prim-typing} we have $\varnothing \vdash_ w ty(c) : k$, where $k$ is either $B$ or $*$ depending on whether $c$ is a Boolean/integer constant or function. By repeated application of Lemma \ref{weakenings}, we have $\Gamma \vdash_w ty(c) : k$. 

{\bf Case} {\sc T-Var}: We have $\Gamma \vdash e : t$ where $e \equiv x$ and $t \equiv {\rm self}(t',x)$. By inversion, $x\bind t' \in \Gamma$, so we can write $\Gamma \equiv \Gamma'', x\bind t',\Gamma'$ and by repeated inversion of {\sc WFE-Bind}, $\vdash_w x\bind t',\Gamma'$. Inverting once more we get $\Gamma' \vdash_w t' : k$. Inductively applying Lemma \ref{weakenings} gives us $\Gamma \vdash_w t' : k$. By a simple inductive argument, selfification of well-formed types are themselves well-formed. Thus we conclude that $\Gamma \vdash_w {\rm self}(t',x) : k$.

{\bf Case} {\sc T-App}: We have $\Gamma \vdash e : t$ where $e \equiv e_1\; e_2$ and $t \equiv \existype{x}{t_x}{t'}.$ By inversion, $\Gamma \vdash e_1 : \functype{x}{t_x}{t'}$ and $\Gamma \vdash e_2 : t_x$. By the inductive hypothesis we have $\Gamma \vdash_w \functype{x}{t_x}{t'} : k$ where $k \equiv *$ because {\sc WF-Func} is the only rule that could have resulted in a well-formedness judgment for a function type. By inverting rule {\sc WF-Func} (on the aforementioned judgment), we have $\Gamma \vdash_w t_x : k_x$ and $y\bind t_x, \Gamma, \vdash_w t'[y/x] : k'$ for some $y\not\in\dom{\Gamma}$. By rule {\sc WF-Exis}, $\Gamma \vdash_w \existype{x}{t_x}{t'} : k'$.

{\bf Case} {\sc T-Abs}: We have $\Gamma \vdash e : t$ where $e \equiv \lambda x.\, e'$ and $t \equiv \functype{x}{t_x}{t'}$. By inversion, we have $y\bind t_x,\Gamma \vdash e[y/x] : t'[y/x]$ and $\Gamma \vdash_w t_x : k_x$ for some $y\not\in\dom{\Gamma}$. By the inductive hypothesis, we have $y\bind t_x, \Gamma\vdash_w t'[y/x] : k'$ for some kind $k'$. By rule {\sc WF-Func} we have $\Gamma \vdash_w \functype{x}{t_x}{t'} : *$.

{\bf Case} {\sc T-AppT}: We have $\Gamma \vdash e : t$ where $e \equiv e'\: [t']$ and $t \equiv s[t'/\al]$. By inversion, $\Gamma \vdash e' : \polytype{\al}{k}{s}$ and $\Gamma \vdash_w t' : k$. By the inductive hypothesis we have $\Gamma \vdash_w \polytype{\al}{k}{s} : k'$ where $k' \equiv *$ because {\sc WF-Poly} is the only rule that could have resulted in a well-formedness judgment for a polymorphic type. 
By inverting rule {\sc WF-Poly} (on the aforementioned judgment), we have $\al'\bind k, \Gamma \vdash_w s[\al'/\al] : k_s$ for some $\al'\not\in\dom{\Gamma}$. By the Substitution Lemma, we have $\Gamma \vdash_w s[\al'/\al][t'/\al'] : k_s$. We conclude by noting that  $s[\al'/\al][t'/\al'] = s[t'/\al]$.

{\bf Case} {\sc T-AbsT}: We have $\Gamma \vdash e : t$ where $e \equiv \Lambda \al:k.\, e'$ and $t \equiv \polytype{\al}{k}{t'}$. By inversion, we have $\al'\bind k,\Gamma \vdash e'[\al'/\al] : t'[\al'/\al]$ and $\al'\bind k,\Gamma \vdash_w t'[\al'/\al] : k'$ for some $\al'\not\in\dom{\Gamma}$. By rule {\sc WF-Func} we have $\Gamma \vdash_w \polytype{\al}{k}{t'} : *$.

{\bf Case} {\sc T-Let}: We have $\Gamma \vdash e : t$ where $e \equiv \letin{x}{e_x}{e'}$. By inversion we have, in particular, that $\Gamma \vdash_w t :k$ for some kind $k$.

{\bf Case} {\sc T-Ann}: We have $\Gamma \vdash e : t$ where $e \equiv e'\col t$. By inversion we have, in particular, that $\Gamma \vdash_w t : k$ for some kind $k$.

{\bf Case} {\sc T-Sub}: We have $\Gamma \vdash e : t$. By inversion we have, in particular, $\Gamma \vdash_w t : k$ for some kind $k$.
\end{proof} 

\begin{lemma}\label{witness-sub}
(Witnesses and subtyping) If $\Gamma \vdash v_x : t_x$ and $y\bind t_x,\Gamma \vdash_w t : k$ then $\Gamma \vdash t[v_x/x] <: \existype{x}{t_x}{t}$.
\end{lemma}
\begin{proof}
By Lemma \ref{sub-refl}, we have that $y\bind t_x \Gamma \vdash t <: t$ and by the Substitution Lemma we have $\Gamma \vdash t[v_x/x] <: t[v_x/x]$.  Applying rule {\sc S-Witn}, we get $\Gamma \vdash t[v_x/x] <: \existype{x}{t_x}{t}$.
\end{proof}

\begin{lemma}\label{subtype-env} (Narrowing)
We can replace types by subtypes in the environment. More precisely, if $\Gamma \vdash s_x <: t_x$ then \\
1. If $\Gamma', x\bind t_x, \Gamma \vdash_w t : k$ then
\[
\Gamma', x\bind s_x, \Gamma \vdash_w t : k.
\]
2. If $\Gamma', x\bind t_x, \Gamma \vdash_e p$ then 
\[
\Gamma', x\bind s_x, \Gamma \vdash_e p. 
\]
3. If $\Gamma', x\bind t_x, \Gamma \vdash t_1 <: t_2$ then
\[
\Gamma', x\bind s_x, \Gamma \vdash t_1 <: t_2.
\]
4. If $\Gamma', x\bind t_x, \Gamma \vdash e : t$ then
\[
\Gamma', x\bind s_x, \Gamma \vdash e : t.
\]
\end{lemma}
\begin{proof}
(1) We proceed by induction on the derivation tree of $\Gamma', x\bind t_x, \Gamma \vdash_w t : k$.

{\bf Case} {\sc WF-Refn}: We have $\Gamma', x\bind t_x, \Gamma \vdash_w b\{y\col p\} : B$. By inversion, we have 
\begin{equation}
z\bind b, \lfloor \Gamma'\rfloor, x\bind \lfloor t_x\rfloor, \lfloor\Gamma\rfloor \vdash_B p[z/y] : \Bool
\end{equation}
for some $z\not\in\dom{\Gamma', x\bind t_x, \Gamma}$. By Lemma \ref{sub-erase}, $\lfloor s_x\rfloor \overset{\al}{=} \lfloor t_x\rfloor$. Judgments in our System F remain valid {\em mutatis mutandis} under alpha-renaming bound variables in types in the environment, so we obtain $z\bind b, \lfloor \Gamma'\rfloor, x\bind \lfloor s_x\rfloor, \lfloor\Gamma\rfloor \vdash_B p[z/y] : \Bool$. Applying rule {\sc WF-Refn}, $\Gamma', x\bind s_x, \Gamma \vdash_w b\{y\col p\} : B$.

{\bf Case} {\sc WF-Kind}: We have $\Gamma', x\bind t_x, \Gamma \vdash_w t : *$. By inversion we have $\Gamma', x\bind t_x, \Gamma \vdash_w t : B$. By the inductive hypothesis, $\Gamma', x\bind s_x, \Gamma \vdash_w t : B$. Then by rule {\sc WF-Kind}, $\Gamma', x\bind s_x, \Gamma \vdash t: *$.

{\bf Case} {\sc WF-Var}: We have $\Gamma', x\bind t_x, \Gamma \al : k$. By inversion we have $\al\bind k \in \Gamma', x\bind t_x, \Gamma$ and thus $\al\bind k \in \Gamma', x\bind s_x, \Gamma$. By rule {\sc WF-Var} we conclude $\Gamma', x\bind s_x, \Gamma \vdash_w \al : k$.

{\bf Case} {\sc WF-Func}: We have $\Gamma', x\bind t_x, \Gamma \vdash_w \functype{y}{t_y}{t} : *$. By inversion, $\Gamma', x\bind t_x, \Gamma \vdash_w t_y : k_y$ and $z\bind t_y, \Gamma', x\bind t_x, \Gamma \vdash_w t[z/y] : k$ for some $z\not\in\dom{\Gamma', x\bind t_x, \Gamma} = \dom{\Gamma', x\bind s_x, \Gamma}$. By the inductive hypothesis, $\Gamma', x\bind s_x, \Gamma \vdash_w t_y : k_y$ and $z\bind t_y, \Gamma', x\bind s_x, \Gamma \vdash_w t[z/y] : k$. Then applying {\sc WF-Func} we conclude $\Gamma', x\bind s_x, \Gamma \vdash_w \functype{y}{t_y}{t} : *$.

{\bf Case} {\sc WF-Exis}: We have $\Gamma', x\bind t_x, \Gamma \vdash_w \existype{y}{t_y}{t} : k$. By inversion, $\Gamma', x\bind t_x, \Gamma \vdash_w t_y : k_y$ and $z\bind t_y, \Gamma', x\bind t_x, \Gamma \vdash_w t[z/y] : k$ for some $z\not\in\dom{\Gamma', x\bind t_x, \Gamma} = \dom{\Gamma', x\bind s_x, \Gamma}$. By the inductive hypothesis, $\Gamma', x\bind s_x, \Gamma \vdash_w t_y : k_y$ and $z\bind t_y, \Gamma', x\bind s_x, \Gamma \vdash_w t[z/y] : k$. Then applying {\sc WF-Exis} we conclude $\Gamma', x\bind s_x, \Gamma \vdash_w \existype{y}{t_y}{t} : k$.

{\bf Case} {\sc WF-Poly}: We have $\Gamma', x\bind t_x, \Gamma \vdash_w \polytype{\al}{k}{t} : *$. By inversion, we have $\al'\bind k,\Gamma', x\bind t_x, \Gamma \vdash_w t[\al'/\al] : k_t$ for some $\al\not\in\dom{\Gamma', x\bind t_x, \Gamma \vdash_w} = \dom{\Gamma', x\bind s_x, \Gamma \vdash_w}$. By the inductive hypothesis we have, $\al'\bind k,\Gamma', x\bind s_x, \Gamma \vdash_wt[\al'/\al] : k_t$ and by rule {\sc WF-Poly} we conclude $\Gamma', x\bind s_x, \Gamma \vdash_w \polytype{\al}{k}{t} : *$.

(2) We have $\Gamma', x\bind t_x, \Gamma \vdash_e p$ and by inversion of the only rule we have that $\forall \theta.\,\theta\in \lb\Gamma', x\bind t_x, \Gamma \rb \Rightarrow  \theta(p) \many \true$. We observe that if $\theta \in \lb\Gamma', x\bind s_x, \Gamma \rb$ then $\theta(x) \in \lb\theta(s_x)\rb \subseteq \lb\theta(t_x)\rb$ by Lemma \ref{type-denote}; therefore $\theta \in \lb\Gamma', x\bind t_x, \Gamma \rb$. Then we have the statement $\forall \theta.\,\theta\in \lb\Gamma', x\bind s_x, \Gamma \rb \Rightarrow  \theta(p) \many \true$, and by rule {\sc Ent-Pred} we conclude $\Gamma', x\bind s_x, \Gamma \vdash_e p$.

(3) We proceed by mutual induction on the derivation of the subtyping and typing judgments (part 4).

{\bf Case} {\sc S-Base}: We have $\Gamma', x\bind t_x, \Gamma \vdash b\{y_1\col p_1\} <: b\{y_2\col p_2\}$. By inversion, we have $z\bind b\{y_1\col p_1\}, \Gamma', x\bind t_x, \Gamma \vdash_e p2[z/y_2]$ for some $z\not\in\dom{\Gamma', x\bind t_x, \Gamma}$. By part (2) we have $z\bind b\{y_1\col p_1\}, \Gamma', x\bind s_x, \Gamma \vdash_e p[z/y_2]$ and by rule {\sc S-Base} we conclude $\Gamma', x\bind s_x, \Gamma \vdash b\{y_1\col p_1\} <: b\{y_2\col p_2\}$.

{\bf Case} {\sc S-Func}: We have $\Gamma', x\bind t_x, \Gamma \vdash \functype{y_1}{s_1}{t_1} <: \functype{y_2}{s_2}{t_2}$. By inversion we have $\Gamma', x\bind t_x, \Gamma \vdash s_2 <: s_1$ and $z\bind s_2, \Gamma', x\bind t_x, \Gamma \vdash t_1[z/y_1] <: t_2[z/y_2]$ for some $z\not\in\dom{\Gamma', x\bind t_x, \Gamma }$. By the inductive hypothesis, we have $\Gamma', x\bind s_x, \Gamma \vdash s_2 <: s_1$ and $z\bind s_2, \Gamma', x\bind s_x, \Gamma \vdash t_1[z/y_1] <: t_2[z/y_2]$. By rule {\sc S-Func} we conclude $\Gamma', x\bind s_x, \Gamma \vdash \functype{y_1}{s_1}{t_1} <: \functype{y_2}{s_2}{t_2}$.

{\bf Case} {\sc S-Witn}: We have $\Gamma', x\bind t_x, \Gamma \vdash t <: \existype{y}{t_y}{t'}$. By inversion we have $\Gamma', x\bind t_x, \Gamma \vdash v_y : t_y$ and $\Gamma', x\bind t_x, \Gamma \vdash t <: t'[v_y/y]$ for some value $v_y$. By the inductive hypothesis we have $\Gamma', x\bind s_x, \Gamma \vdash v_y : t_y$ and $\Gamma', x\bind s_x, \Gamma t <: t'[v_y/y]$. We conclude by rule {\sc S-Witn} that $\Gamma', x\bind s_x, \Gamma \vdash t <: \existype{y}{t_y}{t'}$.

{\bf Case} {\sc S-Bind}: We have $\Gamma', x\bind t_x, \Gamma \vdash \existype{y}{t_y}{t}<: t$. By inversion, $z\bind t_y,\Gamma', x\bind t_x, \Gamma \vdash t[z/y] <: t'$ for some $z\not\in\dom{\Gamma', x\bind t_x, \Gamma}$ such that $z \not\in free(t')$. By the inductive hypothesis, $z\bind t_y, \Gamma', x\bind s_x, \Gamma \vdash t[z/y] <: t'$. Then by rule {\sc S-Bind} we conclude $\Gamma', x\bind s_x, \Gamma \vdash \existype{y}{t_y}{t} <: t'$.

{\bf Case} {\sc S-Poly}: We have $\Gamma', x\bind t_x, \Gamma \vdash \polytype{\al_1}{k}{t_1}<: \polytype{\al_2}{k}{t_2}$. By inversion, $\al\bind k, \Gamma', x\bind t_x, \Gamma \vdash t_1[\al/\al_1] <: t_2[\al/\al_2]$ for some $\al\not\in\dom{\Gamma', x\bind t_x, \Gamma}$. By the inductive hypothesis, we have $\al\bind k, \Gamma', x\bind s_x, \Gamma \vdash t_1[\al/\al_1] <: t_2[\al/\al_2]$ and by rule {\sc S-Poly} we get $\Gamma', x\bind s_x, \Gamma \vdash \polytype{\al_1}{k}{t_1} <: \polytype{\al_2}{k}{t_2}$.

(4) As in part (3), we proceed by mutual induction on the derivation of the subtyping and typing judgments.

{\bf Case} {\sc T-Prim}: We have $\Gamma', x\bind t_x, \Gamma \vdash c : t$. By inversion, $ty(c) = t$, so by {\sc T-Prim} we have $\Gamma', x\bind s_x, \Gamma \vdash c : t$.

{\bf Case} {\sc T-Var}: We have $\Gamma', x\bind t_x, \Gamma \vdash y : {\rm self}(t,y)$. By inversion, $y\bind t \in \Gamma', x\bind t_x, \Gamma$. If $y\neq x$ then $y\bind t \in \Gamma', x\bind s_x, \Gamma$ and we conclude by rule {\sc T-Var}. If $y = x$ and $t = t_x$ then we have that $\Gamma', x\bind s_x, \Gamma \vdash y : {\rm self}(s_x, y)$. 
By Lemma \ref{exactness}, $\Gamma', x\bind s_x, \Gamma \vdash {\rm self}(s_x, y) <: {\rm self}(t_x, y)$. By rule {\sc T-Sub} we conclude that $\Gamma', x\bind s_x, \Gamma \vdash y : {\rm self}(t_x, y)$.

{\bf Case} {\sc T-App}: We have $\Gamma', x\bind t_x, \Gamma \vdash e\, e' : \existype{y}{t_y}{t'}$. By inversion, $\Gamma', x\bind t_x, \Gamma \vdash e : \functype{y}{t_y}{t'}$ and $\Gamma', x\bind t_x, \Gamma \vdash e' : t_y$. Applying the inductive hypothesis twice, $\Gamma', x\bind s_x, \Gamma \vdash e : \functype{y}{t_y}{t'}$ and $\Gamma', x\bind s_x, \Gamma \vdash e' : t_y$. By rule {\sc T-App} we conclude that $\Gamma', x\bind s_x, \Gamma \vdash e\, e' : \existype{y}{t_y}{t'}$.

{\bf Case} {\sc T-Abs}: We have $\Gamma', x\bind t_x, \Gamma \vdash \lambda x.\, e : \functype{y}{t_y}{t'}$. By inversion, 
$z\bind t_y, \Gamma', x\bind t_x, \Gamma \vdash e[z/y] : t'[z/y]$ and $\Gamma', x\bind t_x, \Gamma t_y : k_y$ for some $z\not\in\dom{\Gamma', x\bind t_x, \Gamma}$. Applying the inductive hypothesis twice, $z\bind t_y, \Gamma', x\bind s_x, \Gamma \vdash e[z/y] : t'[z/y]$ and $\Gamma', x\bind s_x, \Gamma t_y : k_y$. Then by rule {\sc T-Abs} we conclude $\Gamma', x\bind s_x, \Gamma \vdash \lambda x.\, e : \functype{y}{t_y}{t'}$.

{\bf Case} {\sc T-AppT}: We have $\Gamma', x\bind t_x, \Gamma \vdash e\,[t'] : s[t'/\al]$. By inversion, $\Gamma', x\bind t_x, \Gamma \vdash e : \polytype{\al}{k}{s}$ and $\Gamma', x\bind t_x, \Gamma t' : k'$. By part (1) and by applying the inductive hypothesis, $\Gamma', x\bind s_x, \Gamma \vdash e : \polytype{\al}{k}{s}$ and $\Gamma', x\bind s_x, \Gamma t' : k'$. Applying rule {\sc T-AppT} we conclude $\Gamma', x\bind s_x, \Gamma \vdash e\,[t'] : s[t'/\al]$

{\bf Case} {\sc T-AbsT}: We have $\Gamma', x\bind t_x, \Gamma \vdash \Lambda\al\bind k.\,e : \polytype{\al}{k}{t}$. By inversion, $\al'\bind k,\Gamma', x\bind t_x, \Gamma \vdash e[\al'/\al] : t[\al'/\al]$ and $\al'\bind k,\Gamma', x\bind t_x, \Gamma \vdash_w t[\al'/\al] : k'$ for some $\al'\not\in\dom{\Gamma', x\bind t_x, \Gamma}$. By the inductive hypothesis, $\al'\bind k,\Gamma', x\bind s_x, \Gamma \vdash e[\al'/\al] : t[\al'/\al]$ and $\al'\bind k,\Gamma', x\bind s_x, \Gamma \vdash_w t[\al'/\al] : k'$. We conclude by rule {\sc T-AbsT} that $\Gamma', x\bind s_x, \Gamma \vdash \Lambda\al\bind k.\,e : \polytype{\al}{k}{t}$.

{\bf Case} {\sc T-Let}: We have $\Gamma', x\bind t_x, \Gamma \vdash \letin{y}{e_y}{e} : t$. By inversion, we get $\Gamma', x\bind t_x, \Gamma \vdash e_y : t_y$ and $z\bind t_y,\Gamma', x\bind t_x, \Gamma \vdash e[z/y] : t[z/y]$ and $\Gamma', x\bind t_x, \Gamma \vdash_w t : k$ for some $z\not\in\dom{\Gamma', x\bind t_x, \Gamma}$. By the inductive hypothesis, $\Gamma', x\bind s_x, \Gamma \vdash e_y : t_y$ and $z\bind t_y,\Gamma', x\bind s_x, \Gamma \vdash e[z/y] : t[z/y]$ and $\Gamma', x\bind s_x, \Gamma \vdash_w t : k$. By rule {\sc T-Let} we conclude $\Gamma', x\bind s_x, \Gamma \vdash \letin{y}{e_y}{e} : t$.

{\bf Case} {\sc T-Ann}: We have $\Gamma', x\bind t_x, \Gamma \vdash (e\col t) : t$. By inversion, $\Gamma', x\bind t_x, \Gamma \vdash e: t$ and $\Gamma', x\bind t_x, \Gamma \vdash_w t : k$. By part (1) and by the inductive hypothesis, $\Gamma', x\bind s_x, \Gamma \vdash e: t$ and $\Gamma', x\bind s_x, \Gamma \vdash_w t : k$. By rule {\sc T-Ann} we conclude $\Gamma', x\bind s_x, \Gamma \vdash (e\col t) : t$.

{\bf Case} {\sc T-Sub}: We have $\Gamma', x\bind t_x, \Gamma \vdash e : t$. By inversion, $\Gamma', x\bind t_x, \Gamma \vdash e : s$, $\Gamma', x\bind t_x, \Gamma \vdash s <: t$ and $\Gamma', x\bind t_x, \Gamma \vdash_w t : k$. By the (mutually) inductive hypothesis, we have $\Gamma', x\bind s_x, \Gamma \vdash e : s$, $\Gamma', x\bind s_x, \Gamma \vdash s <: t$ and $\Gamma', x\bind s_x, \Gamma \vdash_w t : k$. By rule {\sc T-Sub} we conclude $\Gamma', x\bind s_x, \Gamma \vdash e : t$.

\end{proof}

\begin{lemma}\label{sub-trans}
If $\Gamma \vdash t <: t'$ and $\Gamma \vdash t' <: t''$ then $\Gamma \vdash t <: t''$.
\end{lemma}

\begin{proof}
We proceed by induction on the combined size of the derivation trees of $\Gamma \vdash t' <: t''$ then $\Gamma \vdash t <: t''$. We first consider the cases where none of $t, t',$ or $t''$ are existential types. 

{\bf Case} {\sc S-Base}: In this case $t \equiv b\{x_1\col p_1\}$, $t' \equiv b\{x_2\col p_2\}$, and $t'' \equiv b\{x_3\col p_3\}$.

\end{proof}

\begin{lemma}\label{sub-closure}
Let $<:^*$ denote the reflexive and transitive closure of the subtyping judgment $<:$. If $\Gamma \vdash t <:^* t'$ then $\Gamma \vdash t <: t'$.
\end{lemma}

\begin{lemma}\label{invert-app}
If $\Gamma \vdash \lambda x.\, e : \functype{x}{t_x}{t}$ then $y\bind t_x, \Gamma e : t[y/x]$ for some $y\not\in\dom{\Gamma}$.
\end{lemma}

\begin{theorem}\label{progress}
(The Progress Theorem) If $\varnothing \vdash e : t$ then either $e$ is a value or there exists a term $e'$ such that $e \hookrightarrow$ e'.
\end{theorem}

\begin{proof} We proceed by induction on the derivation tree of the judgment $\varnothing \vdash e : t$.

{\bf Case} {\sc T-Prim}: This case holds trivially because $e \equiv c$ is a value.

{\bf Case} {\sc T-Var}: This case cannot occur because $\Gamma = \varnothing$.

{\bf Case} {\sc T-App}: We have $\varnothing \vdash e : t$ where $e \equiv e_1\; e_2$ and $t \equiv \existype{x}{t_x}{t'}$. By inversion, $\varnothing \vdash e_1 : \functype{x}{t_x}{t'}$ and $\varnothing \vdash e_2 : t_x$. We split on five cases for the structure of $e_1$ and $e_2$.

First, consider $e_1 \equiv c$ and $e_2 \equiv v$; then by rule {\sc E-Prim} $e \equiv c\; v \hookrightarrow \delta(c,v)$, which is defined by Lemma \ref{prim-typing}.
Second, consider $e_1 \equiv c$ and $e_2$ not a value. By the inductive hypothesis (applied to $\varnothing \vdash e_2 : t_x$), there exists a term $e'_2$ such that $e_2 \step e'_2$. Thus $e_1\; e_2 \step e_1 \; e'_2$ by rule {\sc E-App1}.

Third, consider $e_1 \equiv \lambda x.e'_1$ and $e_2 \equiv v$. Then by the operational semantics, $\lambda x.e_2 \; v \step e_2[v/x]$. Fourth, consider $e_1 \equiv \lambda x.e'_1$ and $e_2$ not a value. By the inductive hypothesis, there exists a term $e'_2$ such that $e_2 \step e'_2$. Thus $e_1\; e_2 \step e_1 \; e'_2$ by {\sc E-App1} again.

This exhausts all possible cases in which $e_1$ could be a value in the empty environment. So, finally, consider $e_1$ not a value. Then by the inductive hypothesis there exists $e'_1$ such that $e_1 \hookrightarrow e'_1$. By the operational semantics, $e_1\; e_2 \hookrightarrow e'_1\; e_2$.

{\bf Case} {\sc T-Abs} and {\sc T-AbsT}: These cases holds trivially because $e \equiv \lambda x.e'$ is a value and so is $e \equiv \Lambda \al:k.e'$.

{\bf Case} {\sc T-AppT}: We have $\varnothing \vdash e : t$ where $e \equiv e'\; [t']$ and $t \equiv s[t'/\al]$. By inversion, $\varnothing \vdash e' : \polytype{\al}{k}{s}$ and $\varnothing \vdash_w t' : k$. There are two possible cases for the structure of $e'$. {\em Note: We'll get another case if we introduce any polymorphic primitives}. 

First, if $e'$ is a value then it can't be a variable because it is typed in the empty environment. So the only possibility is that $e' \equiv \Lambda \al\bind k'.e''$. Then by the operational semantics $e\equiv \Lambda \al\bind k'.e''\; [t'] \step e''[t'/\al]$. Second, $e'$ is not a value. Then by the inductive hypothesis there is some term $e''$ such that $e' \step e''$. Then by rule {\sc E-AppT} of the operation semantics, $e \equiv e'\; [t'] \step e''\; [t']$.

{\bf Case} {\sc T-Let}: We have $\varnothing \vdash e : t$ where
$e \equiv (\letin{x}{e_1}{e_2})$. By inversion, $\varnothing \vdash e_1:t_x$ and $y\bind t_x\vdash e_2[y/x] : t[y/x]$ for some $y$. First, suppose that $e_1 \equiv v$. Then by rule {\sc T-LetV}, $\letin{x}{v}{e_2} \step e_2[v/x]$. Second, suppose that $e_1$ is not a value. Then by the inductive hypothesis (applied to judgement $\varnothing \vdash e_1:t_x$), there exists a term $e'_1$ such that $e_1 \step e'_1$. Then by rule {\sc E-Let} we have $\letin{x}{e_1}{e_2} \step \letin{x}{e'_1}{e_2}$.

{\bf Case} {\sc T-Ann}: We have $\varnothing \vdash e : t$ where $e \equiv (e_1\col t)$. By inversion, $\varnothing \vdash e_1 : t$. By the inductive hypothesis either $e_1 \equiv v$ a value or there exists $e'_1$ such that $e_1 \hookrightarrow e'_1$. In the former case $(v\col t) \hookrightarrow v$ and in the latter case $(e_1\col t) \hookrightarrow (e'_1\col t)$.

{\bf Case} {\sc T-Sub}: We have $\varnothing \vdash e : t$. By inversion, $\varnothing \vdash e : s$, $\varnothing \vdash s <: t$, and $\varnothing \vdash_w t : k$ for some type $s$. By the inductive hypothesis, either $e$ is a value or there exists $e'$ such that $e \hookrightarrow e'$ and we are done.
\end{proof}


\begin{theorem}(The Preservation Theorem)
If $\varnothing \vdash e : t$ and $e \hookrightarrow e'$, then $\varnothing \vdash e' : t$.	
\end{theorem} 
\begin{proof} 
We proceed by induction on the derivation tree of the judgment $\varnothing \vdash e : t$.

{\bf Case} {\sc T-Prim}: Holds trivially because if $e \equiv c$ then there does not exist $e'$ such that $c \hookrightarrow e'$.

{\bf Case} {\sc T-Var}: Holds trivially because if $e \equiv x$ then there does not exist $e'$ such that $x \hookrightarrow e'$.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

{\bf Case} {\sc T-App}: We have $\varnothing \vdash e : t$ where $e \equiv e_1\; e_2$ and $t \equiv \existype{x}{t_x}{t'}$ for some variable $x$ and type $t_x$. By inversion, $\varnothing \vdash e_1 : \functype{x}{t_x}{t'}$ and $\varnothing \vdash e_2 : t_x$. We split on five cases for the structure of $e_1$ and $e_2$.

First, consider $e_1 \equiv c$ and $e_2 \equiv v$; then by the determinism of the semantics $e' = \delta(c,v)$. By Lemma \ref{prim-typing} we have $\varnothing \vdash c : ty(c)$ and write $ty(c) = \functype{z}{t_z}{t''}$. By Lemma \ref{prim-subtyping} we have $\varnothing \vdash \functype{z}{t_z}{t''} <: \functype{x}{t_x}{t'}$. Inverting the last rule used in that derivation, which must be {\sc S-Func}, we have $y\bind t_x \vdash t''[y/z] <: t'[y/z]$. By the Substitution Lemma we have $\varnothing \vdash t''[y/z][v/y] <: t'[y/x][v/y]$, which is the same as $\varnothing \vdash t''[v/z] <: t'[v/x]$.
By Lemma \ref{prim-typing}, we have $\varnothing \vdash \delta(c,v) : t''[v/z]$. We also have $\varnothing \vdash t'[v/x] : k$ for some kind $k$ by Lemma \ref{types-wf} and the Substitution Lemma. Then we can apply rule {\sc T-Sub} to obtain $\varnothing \vdash \delta(c,v) : t'[v/x]$. By Lemma \ref{witness-sub}, $\varnothing \vdash t'[v/x] <: \existype{x}{t_x}{t'}$, and so by rule {\sc T-Sub} again (by Lemma \ref{types-wf}, we have $\varnothing \vdash_w \existype{x}{t_x}{t'}$), $\varnothing \vdash \delta(c,v) : \existype{x}{t_x}{t'} $.

Second, consider $e_1 \equiv c$ and $e_2$ not a value. By Theorem \ref{progress}, there exists a term $e'_2$ such that $e_2 \step e'_2$. By rule {\sc E-App2}, $c\; e_2 \step c\; e'_2$ and by the determinism of the operational semantics, $e' \equiv c\; e'_2$. By the inductive hypothesis, $\varnothing \vdash e'_2 : t_x$. We conclude by {\sc T-App} that $\varnothing \vdash e' : \existype{x}{t_x}{t'}$.

Third, consider $e_1 \equiv \lambda x.e'_1$ and $e_2 \equiv v$. Then $e_1\; e_2 \step e'_1[v/x]$ and by determinism of the operational semantics, $e' \equiv e'_1[v/x]$. Consider the proof tree deriving $\varnothing \vdash \lambda x.e'_1 : \functype{x}{t_x}{t'}$...


There are two rules that could have been used last in $\varnothing \vdash \lambda x.e'_1 : \functype{x}{t_x}{t'}$. If the last rule used were {\sc T-Abs}, then by inversion we have %$x\bind t_x \vdash e'_1 : t'$, and by the substitution lemma we have $\varnothing \vdash e'_1[v/x] : t'[v/x]$. By Lemma \ref{types-wf}, we have $\varnothing \vdash_w \existype{x}{t_x}{t'}$ and by inverting {\sc WF-Exis} we have $x\bind t_x \vdash_w t'$. By Lemma \ref{witness-sub}, $\varnothing \vdash t'[v/x] <: \existype{x}{t_x}{t'}$, and so by rule {\sc T-Sub}, $\varnothing \vdash e' : \existype{x}{t_x}{t'}$.
If the last rule used were {\sc T-Sub}, then inversion gives us $\varnothing \vdash \lambda x.e'_1 : s$ and $\varnothing \vdash s <: \functype{x}{t_x}{t'}$ for some type s. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



Third, consider $e_1 \equiv \lambda x.e'_1$ and $e_2 \equiv v$. Then $e_1\; e_2 \step e'_1[v/x]$ and by determinism of the operational semantics, $e' \equiv e'_1[v/x]$. By inversion of {\sc T-Abs}, we have $x\bind t_x \vdash e'_1 : t'$, and by the substitution lemma we have $\varnothing \vdash e'_1[v/x] : t'[v/x]$. By Lemma \ref{types-wf}, we have $\varnothing \vdash_w \existype{x}{t_x}{t'}$ and by inverting {\sc WF-Exis} we have $x\bind t_x \vdash_w t'$. By Lemma \ref{witness-sub}, $\varnothing \vdash t'[v/x] <: \existype{x}{t_x}{t'}$, and so by rule {\sc T-Sub}, $\varnothing \vdash e' : \existype{x}{t_x}{t'}$.

Fourth, consider $e_1 \equiv \lambda x.e'_1$ and $e_2$ not a value. By Theorem \ref{progress}, there exists a term $e'_2$ such that $e_2 \step e'_2$. By rule {\sc E-App2}, $(\lambda x.e'_1)\; e_2 \step (\lambda x.e'_1)\; e'_2$ and by the determinism of the operational semantics, $e' \equiv (\lambda x.e'_1)\; e'_2$.
By the inductive hypothesis, $\varnothing \vdash e'_2 : t_x$. We conclude by {\sc T-App} that $\varnothing \vdash e' : \existype{x}{t_x}{t'}$.

This exhausts all possible cases in which $e_1$ could be a value in the empty environment. So, finally, consider $e_1$ not a value.
Then by Theorem \ref{progress}, there exists an $e'_1$ such that $e_1 \hookrightarrow e'_1$. By determinism of the operational semantics, $e' \equiv e'_1\; e_2$. By the inductive hypothesis,
$\varnothing \vdash e'_1 : \existype{x}{t_x}{t'}$. By rule {\sc Syn-App}, $\varnothing \vdash e' : \existype{x}{t_x}{t'}$.

{\bf Case} {\sc T-Abs}: Holds trivially because if $e \equiv \lambda x.e_1$ then there does not exist any $e'$ such that $\lambda x.e_1 \hookrightarrow e'$.

{\bf Case} {\sc T-AbsT}: Holds trivially because if $e \equiv \Lambda\al\bind k.e_1$ then there does not exist any $e'$ such that $\Lambda\al\bind k.e_1 \hookrightarrow e'$.

{\bf Case} {\sc T-Let}: We have $\varnothing \vdash e : t$ where $e \equiv (\letin{x}{e_1}{e_2})$ and $t \equiv t_2$. By inversion,
$\varnothing \vdash e_1 : t_1$,\quad $x\bind t_1\vdash e_2 : t_2$, and $\varnothing \vdash_w t_2$ for some type $t_1$. 
First suppose that $e_1$ is not a value. Then by Theorem \ref{progress}, there exists some term $e'_1$ such that $e_1 \step e'_1$. By Rule {\sc E-Let}, $\letin{x}{e_1}{e_2} \step \letin{x}{e'_1}{e_2}$, and by determinism of the operational semantics, $e' \equiv \letin{x}{e'_1}{e_2}$. By the inductive hypothesis, $\varnothing \vdash e_1 : t_1$. Then by {\sc T-Let}, $\varnothing \vdash e' : t_2$.

Second, suppose that $e_1 \equiv v$, for some value $v$. Then by rule {\sc E-LetV}, $\letin{x}{v}{e_2}\step e_2[v/x]$. By determinism of the operational semantics, $e' \equiv e_2[v/x]$. By the substitution lemma, $\varnothing \vdash e_2[v/x] : t_2[v/x]$. But by $\varnothing vdash_w t_2$, we know that $x$ does not appear free in $t_2$ so $t_2[v/x] = t_2$ and $\varnothing \vdash e' : t_2$.

{\bf Case} {\sc T-Ann}: We have $\varnothing \vdash e : t$ where $e \equiv (e_1 : t)$ and $e \hookrightarrow e'$. By inversion,
$\varnothing \vdash e_1 : t$. By Theorem \ref{progress} there exists $e'_1$ such that $e_1 \hookrightarrow e'_1$. By rule {\sc E-Ann} $(e_1 : t) \hookrightarrow (e'_1 : t)$ and by the determinism of the operational semantics we must have $e' \equiv (e'_1 : t)$. Then by the inductive hypothesis, $\varnothing \vdash e'_1 : t$. By rule {\sc Syn-Ann}, $\varnothing \vdash (e'_1 : t) : t$. 

{\bf Case} {\sc T-Sub}: We have $\varnothing \vdash e : t$. By inversion $\varnothing \vdash e : s$ and $\varnothing \vdash s <: t$ for some type $s$, and also $\varnothing \vdash_w t$. By the inductive hypothesis $\varnothing \vdash e' : s$. By rule {\sc Chk-Syn}, $\varnothing \vdash e' : t$.

\end{proof}
\end{document}